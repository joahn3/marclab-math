<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MarcLab ‚Üí PlusMinus (Cosmic)</title>
  <meta name="description" content="MarcLab PlusMinus v2.1. Securitate v1 + GraficƒÉ v2 + Sunet." />
  <style>
    :root {
      /* --- TEMA COSMICƒÇ (v2) --- */
      --bg: #0f172a;       /* Dark Blue Space */
      --card: #1e293b;     /* Card Background */
      --line: rgba(255,255,255,0.1);
      --text: #f1f5f9;
      --muted: #94a3b8;
      
      /* Accente */
      --accent: #38bdf8;   /* Cyan Neon */
      --accent-dim: rgba(56, 189, 248, 0.15);
      --gold: #facc15;     /* Coins/Stars */
      --good: #4ade80;     /* Green */
      --bad: #fb7185;      /* Red */
      --warn: #fbbf24;     /* Orange */
      
      --shadow: 0 12px 30px rgba(0,0,0,0.5);
      --radius: 22px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    
    body {
      margin: 0; font-family: var(--font);
      background: 
        radial-gradient(circle at 15% 10%, rgba(124, 58, 237, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 80%, rgba(56, 189, 248, 0.1) 0%, transparent 40%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex; align-items: stretch; justify-content: center;
      padding: 18px;
    }

    .app { width: min(980px, 100%); display: flex; flex-direction: column; gap: 16px; }

    /* --- TOP BAR (Hibrid v1+v2) --- */
    .top {
      display: flex; gap: 12px; flex-wrap: wrap;
      align-items: center; justify-content: space-between;
      background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px);
      padding: 12px 16px; border-radius: var(--radius);
      border: 1px solid var(--line);
    }
    .brand { display: flex; flex-direction: column; }
    .brand b { font-size: 18px; color: var(--accent); letter-spacing: -0.02em; }
    .brand span { font-size: 12px; color: var(--muted); }

    /* Level Selector & Sound Toggle */
    .controls { display: flex; gap: 8px; align-items: center; }
    .pill-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--line);
      color: var(--muted); padding: 8px 14px; border-radius: 99px;
      font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s;
    }
    .pill-btn.active { background: var(--accent); color: #0f172a; border-color: var(--accent); }
    .pill-btn.icon { padding: 8px; }

    .stats { display: flex; gap: 10px; }
    .stat {
      padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 99px;
      border: 1px solid var(--line); font-size: 13px; font-weight: 700;
      display: flex; gap: 6px; align-items: center;
    }
    .stat.gold { color: var(--gold); border-color: rgba(250, 204, 21, 0.2); }

    /* --- LAYOUT (v1 Structura Grid) --- */
    .main { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 16px; }
    @media (max-width: 880px) { .main { grid-template-columns: 1fr; } }

    /* --- CARDS --- */
    .card {
      background: var(--card); border: 1px solid var(--line);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 20px; position: relative; overflow: hidden;
    }
    .prompt { display: flex; flex-direction: column; gap: 16px; min-height: 460px; justify-content: space-between; }

    /* --- GAME AREA --- */
    .problem-header { display: flex; justify-content: space-between; align-items: center; }
    .h-text { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; }

    .problem-body {
      flex-grow: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 20px;
    }

    .big-eq {
      font-size: 56px; font-weight: 900; line-height: 1.1;
      display: flex; align-items: center; gap: 14px; flex-wrap: wrap; justify-content: center;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .eqBox {
      min-width: 100px; height: 86px; padding: 0 20px;
      border-radius: 18px; border: 2px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: var(--accent);
      display: flex; align-items: center; justify-content: center;
    }
    .eqBox.filled { border-color: var(--accent); background: var(--accent-dim); }

    .dots-viz { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; max-width: 300px; }
    .dot {
      width: 24px; height: 24px; border-radius: 50%;
      background: var(--accent); box-shadow: 0 0 12px var(--accent-dim);
    }
    .dot.ghost { background: transparent; border: 2px solid rgba(255,255,255,0.2); box-shadow: none; }

    /* --- KEYPAD (v2 Style + v1 Func»õionalitate) --- */
    .kbd { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 400px; width: 100%; margin: 0 auto; }
    .btn {
      border: 1px solid var(--line); background: rgba(255,255,255,0.05);
      color: var(--text); padding: 16px; border-radius: 16px;
      font-size: 24px; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn.small { font-size: 16px; padding: 12px; }
    .btn.warn { background: rgba(251,191,36,0.15); border-color: rgba(251,191,36,0.3); color: var(--warn); }
    .btn.primary { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .btn.ghost { background: transparent; border: none; box-shadow: none; color: var(--muted); font-size: 14px; }

    /* --- FEEDBACK (v2 Overlay) --- */
    .feedback {
      position: absolute; inset: 0; background: rgba(15,23,42,0.95);
      backdrop-filter: blur(8px); display: none;
      flex-direction: column; align-items: center; justify-content: center; gap: 10px;
      z-index: 10; animation: fadeIn 0.2s;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .fb-icon { font-size: 64px; }
    .fb-text { font-size: 24px; font-weight: 800; }
    .fb-sub { color: var(--muted); font-size: 16px; }
    .btn-next {
      margin-top: 20px; background: var(--good); color: #064e3b; border: none;
      padding: 14px 40px; font-size: 20px; font-weight: 800;
      border-radius: 99px; cursor: pointer; box-shadow: 0 0 20px rgba(74,222,128,0.4);
    }

    /* --- SIDE PANEL (v1 Skills) --- */
    .skill-item {
      padding: 10px 0; border-bottom: 1px solid var(--line);
    }
    .skill-top { display: flex; justify-content: space-between; font-size: 13px; font-weight: 700; margin-bottom: 6px; }
    .meter { height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; }
    .fill { height: 100%; background: var(--accent); transition: width 0.5s; }

    /* --- DIALOGS (v1 Security) --- */
    dialog {
      background: var(--card); color: var(--text); border: 1px solid var(--line);
      border-radius: 20px; padding: 24px; width: min(500px, 90vw);
      box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    }
    dialog::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    
    .pinInput {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--line);
      color: white; padding: 14px; font-size: 24px; letter-spacing: 0.5em; text-align: center;
      border-radius: 12px; margin: 16px 0; font-family: monospace;
    }
    textarea {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--line);
      color: var(--muted); font-family: monospace; font-size: 11px;
      border-radius: 12px; min-height: 100px; padding: 10px;
    }

    /* --- TOAST --- */
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--gold); color: #422006; font-weight: 800;
      padding: 10px 24px; border-radius: 99px; z-index: 100;
      box-shadow: 0 10px 30px rgba(250, 204, 21, 0.4);
      display: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="top">
      <div class="brand">
        <b>MarcLab ‚Üí PlusMinus</b>
        <span>v2.1 ‚Ä¢ Cosmic ‚Ä¢ Securizat</span>
      </div>
      
      <div class="controls">
        <button class="pill-btn active" id="btnLvl1" onclick="app.setLevel(1)">L1: 1‚Äì10</button>
        <button class="pill-btn" id="btnLvl2" onclick="app.setLevel(2)">L2: 10‚Äì20</button>
        <button class="pill-btn icon" onclick="app.toggleSound()" id="btnSound">üîä</button>
      </div>

      <div class="stats">
        <div class="stat"><span>XP</span> <span id="uiXp">0</span></div>
        <div class="stat gold"><span>ü™ô</span> <span id="uiCoins">0</span></div>
        <div class="stat"><span>üî•</span> <span id="uiStreak">0</span></div>
      </div>
    </div>

    <div class="main">
      <div class="card prompt">
        <div class="problem-header">
          <div class="h-text" id="uiSkillName">ADUNARE</div>
          <button class="btn ghost" onclick="app.makeEasier()">Prea greu?</button>
        </div>

        <div class="problem-body" id="uiProblem">
          </div>

        <div class="kbd" id="uiKbd">
          </div>

        <div class="feedback" id="uiFeedback">
          <div class="fb-icon" id="fbIcon">‚≠ê</div>
          <div class="fb-text" id="fbTitle">Corect!</div>
          <div class="fb-sub" id="fbSub">+10 XP</div>
          <button class="btn-next" onclick="app.newRound()" id="btnNext">UrmƒÉtorul</button>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div class="card">
          <div class="h-text" style="margin-bottom:12px">AbilitƒÉ»õi (Adaptiv)</div>
          <div id="uiSkills"></div>
        </div>

        <div class="card">
          <div class="h-text" style="margin-bottom:12px">Control PƒÉrinte</div>
          <button class="btn small primary" style="width:100%" onclick="app.parentGate()">Dashboard üîí</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Notificare</div>

  <dialog id="pinDlg">
    <h3>Introducere PIN</h3>
    <p style="color:var(--muted); margin:0">Pentru a accesa setƒÉrile.</p>
    <input id="pinInput" class="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div id="pinMsg" style="color:var(--bad); font-weight:700; height:20px; font-size:13px"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
      <button class="btn small" onclick="document.getElementById('pinDlg').close()">AnuleazƒÉ</button>
      <button class="btn small primary" id="pinOk">ConfirmƒÉ</button>
    </div>
  </dialog>

  <dialog id="parentDlg">
    <h3>Dashboard PƒÉrinte</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin: 16px 0;">
      <button class="btn small warn" onclick="app.resetAll()">Reset TOTAL</button>
      <button class="btn small" onclick="app.giveCoins()">+50 Coins</button>
      <button class="btn small" onclick="app.changePin()">SchimbƒÉ PIN</button>
      <button class="btn small" onclick="app.exportData()">Export JSON</button>
      <label class="btn small" style="display:flex;align-items:center;justify-content:center;cursor:pointer">
        Import
        <input type="file" onchange="app.importData(this)" style="display:none" accept=".json">
      </label>
    </div>
    <div class="h-text">Date Brute (Debug)</div>
    <textarea id="stateDump" readonly></textarea>
    <div style="display:flex; justify-content:flex-end; margin-top:12px">
      <button class="btn small primary" onclick="document.getElementById('parentDlg').close()">√énchide</button>
    </div>
  </dialog>

<script>
/**
 * MarcLab ‚Üí PlusMinus v2.1 Ultimate
 * Integrates v1 Security/Structure with v2 Audio/Logic
 */

// --- 1. Audio Engine (v2) ---
const SFX = (() => {
  let ctx = null;
  let enabled = true;
  function init() { if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)(); }
  function play(freq, type, dur, vol=0.1) {
    if(!enabled || !ctx) return;
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type=type; o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime+dur);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+dur);
  }
  return {
    toggle: ()=>{ enabled=!enabled; if(enabled) init(); return enabled; },
    correct: ()=>{ init(); play(523,'sine',0.1); setTimeout(()=>play(784,'sine',0.3),100); },
    wrong: ()=>{ init(); play(150,'sawtooth',0.3,0.2); setTimeout(()=>play(120,'sawtooth',0.3,0.2),150); },
    click: ()=>{ init(); play(800,'sine',0.05,0.03); }
  };
})();

// --- 2. Crypto & Security (v1) ---
const SEC = {
  salt: () => Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''),
  hash: async (pin, salt) => {
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(pin + ":" + salt));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }
};

// --- 3. App Logic ---
const app = (() => {
  const KEY = 'marclab-plusminus-v2-1';
  const DEFAULT_PIN = "2580";

  // Data Structure (v1 Enhanced)
  function defaultState() {
    return {
      meta: { ver: 2.1, app: "PlusMinus" },
      settings: { level: 1, sound: true },
      security: { salt: "", hash: "" },
      economy: { xp: 0, coins: 0, streak: 0, level: 1 },
      skills: {
        // L1
        add1: { n:"AdunƒÉri (1-10)", l:1, m:0.5 },
        sub1: { n:"ScƒÉderi (1-10)", l:1, m:0.5 },
        mk10: { n:"P√¢nƒÉ la 10", l:1, m:0.4 },
        cnt:  { n:"NumƒÉrƒÉ", l:1, m:0.5 },
        cmp1: { n:"ComparƒÉ (1-10)", l:1, m:0.5 },
        // L2
        add2: { n:"AdunƒÉri (10-20)", l:1, m:0.3 },
        sub2: { n:"ScƒÉderi (10-20)", l:1, m:0.3 },
        cmp2: { n:"ComparƒÉ (10-20)", l:1, m:0.4 }
      },
      history: [] // Last 50 items
    };
  }

  let state = defaultState();
  let current = null;
  let locked = false;
  let inputBuf = "";

  // Helpers
  const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
  const save = () => localStorage.setItem(KEY, JSON.stringify(state));
  const toast = (msg) => {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = "block";
    setTimeout(()=>t.style.display="none", 2000);
  };

  // --- INIT & LOAD ---
  async function init() {
    const raw = localStorage.getItem(KEY);
    if(raw) {
      try {
        const s = JSON.parse(raw);
        if(s.meta && s.skills) state = s;
      } catch(e) { console.error("Data corrupted, reset"); }
    }
    
    // Security Init
    if(!state.security.salt) {
      state.security.salt = SEC.salt();
      state.security.hash = await SEC.hash(DEFAULT_PIN, state.security.salt);
      save();
    }

    renderStats();
    renderSkills();
    newRound();
  }

  // --- GAME ENGINE ---
  function getSkillSet() {
    if(state.settings.level === 1) return ['add1', 'sub1', 'mk10', 'cnt', 'cmp1'];
    return ['add2', 'sub2', 'cmp2'];
  }

  function pickSkill() {
    // Weighted random based on mastery (Adaptive)
    const set = getSkillSet();
    const weights = set.map(k => ({ k, w: (1 - state.skills[k].m) + 0.2 }));
    const sum = weights.reduce((a,b)=>a+b.w, 0);
    let r = Math.random() * sum;
    for(let i of weights) { r-=i.w; if(r<=0) return i.k; }
    return set[0];
  }

  function genProblem() {
    const skKey = pickSkill();
    const sk = state.skills[skKey];
    let p = { skill: skKey, type: 'numpad', viz: null, txt: sk.n };

    if(skKey === 'cnt') {
      const n = rand(3, 10);
      p.ans = n; p.viz = 'dots'; p.a = n;
      p.txt = "C√¢te puncte sunt?";
    }
    else if(skKey === 'mk10') {
      const a = rand(1, 9);
      p.a = a; p.b = 10; p.ans = 10-a; p.op = '+'; 
      p.mode = 'missing'; // a + ? = 10
      p.txt = "C√¢t lipse»ôte p√¢nƒÉ la 10?";
    }
    else if(skKey === 'cmp1') {
      const a = rand(1, 10), b = rand(1, 10);
      p.a = a; p.b = b; p.ans = a===b?'=':(a>b?'>':'<'); p.type = 'cmp';
    }
    else if(skKey === 'cmp2') {
      const a = rand(10, 20), b = rand(10, 20);
      if(a===b) return genProblem(); // Retry
      p.a = a; p.b = b; p.ans = a>b?'>':'<'; p.type = 'cmp';
    }
    else if(skKey === 'add1') {
      const a = rand(1, 8), b = rand(1, 9-a);
      p.a = a; p.b = b; p.op = '+'; p.ans = a+b;
    }
    else if(skKey === 'sub1') {
      const a = rand(2, 9), b = rand(1, a);
      p.a = a; p.b = b; p.op = '‚àí'; p.ans = a-b;
    }
    else if(skKey === 'add2') {
      // Bridging: 8 + 5
      const a = rand(6, 9), b = rand(11-a, 9);
      p.a = a; p.b = b; p.op = '+'; p.ans = a+b;
    }
    else if(skKey === 'sub2') {
      // Crossing: 13 - 5
      const a = rand(11, 18), b = rand(a-9, 9);
      p.a = a; p.b = b; p.op = '‚àí'; p.ans = a-b;
    }

    return p;
  }

  function newRound() {
    locked = false;
    inputBuf = "";
    document.getElementById('uiFeedback').style.display = "none";
    current = genProblem();
    renderProblem();
  }

  function check(val) {
    if(locked || val === "") return;
    locked = true;

    const correct = String(val) === String(current.ans);
    
    // Update Stats
    if(correct) {
      SFX.correct();
      state.economy.xp += 10;
      state.economy.streak++;
      state.skills[current.skill].m = Math.min(0.99, state.skills[current.skill].m + 0.05);
      if(state.economy.streak % 5 === 0) {
        state.economy.coins += 5;
        toast("Streak Bonus! +5 ü™ô");
      }
    } else {
      SFX.wrong();
      state.economy.streak = 0;
      state.skills[current.skill].m = Math.max(0.1, state.skills[current.skill].m - 0.04);
    }

    // Log History
    state.history.push({ t: Date.now(), ok: correct, sk: current.skill });
    if(state.history.length > 50) state.history.shift();
    
    save();
    renderStats();
    renderSkills();

    // Show Feedback
    const fb = document.getElementById('uiFeedback');
    const txt = document.getElementById('fbTitle');
    const sub = document.getElementById('fbSub');
    const btn = document.getElementById('btnNext');

    fb.style.display = "flex";
    if(correct) {
      document.getElementById('fbIcon').innerText = "‚≠ê";
      txt.innerText = "Excelent!"; txt.style.color = "var(--good)";
      sub.innerText = "+10 XP";
      btn.style.background = "var(--good)"; btn.innerText = "ContinuƒÉ";
      btn.focus(); // Focus for Enter key
    } else {
      document.getElementById('fbIcon').innerText = "‚ùå";
      txt.innerText = "Gre»ôit"; txt.style.color = "var(--bad)";
      sub.innerText = `RƒÉspunsul era: ${current.ans}`;
      btn.style.background = "var(--warn)"; btn.innerText = "Am √Æn»õeles";
    }
  }

  function makeEasier() {
    state.skills[current.skill].m = Math.max(0.1, state.skills[current.skill].m - 0.1);
    save();
    toast("Ok, am simplificat pu»õin.");
    newRound();
  }

  // --- RENDERERS ---
  function renderStats() {
    document.getElementById('uiXp').innerText = state.economy.xp;
    document.getElementById('uiCoins').innerText = state.economy.coins;
    document.getElementById('uiStreak').innerText = state.economy.streak;
    document.getElementById('btnLvl1').classList.toggle('active', state.settings.level===1);
    document.getElementById('btnLvl2').classList.toggle('active', state.settings.level===2);
    document.getElementById('btnSound').style.opacity = state.settings.sound ? 1 : 0.5;
  }

  function renderSkills() {
    const box = document.getElementById('uiSkills');
    box.innerHTML = "";
    const set = getSkillSet();
    set.forEach(k => {
      const sk = state.skills[k];
      const pct = Math.round(sk.m * 100);
      box.innerHTML += `
        <div class="skill-item">
          <div class="skill-top"><span>${sk.n}</span> <span>${pct}%</span></div>
          <div class="meter"><div class="fill" style="width:${pct}%"></div></div>
        </div>
      `;
    });
  }

  function renderProblem() {
    const p = current;
    document.getElementById('uiSkillName').innerText = p.txt;
    const body = document.getElementById('uiProblem');
    
    let content = "";
    
    // Visualizations
    if(p.viz === 'dots') {
      let dots = "";
      for(let i=0; i<p.a; i++) dots += `<div class="dot"></div>`;
      content += `<div class="dots-viz" style="margin-bottom:20px">${dots}</div>`;
      content += `<div class="big-eq"><span>=</span><div id="ansBox" class="eqBox">?</div></div>`;
    }
    else if(p.type === 'cmp') {
      content += `<div class="big-eq"><span>${p.a}</span><div id="ansBox" class="eqBox">?</div><span>${p.b}</span></div>`;
    }
    else if(p.mode === 'missing') {
      // 3 + ? = 10
      content += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span><div id="ansBox" class="eqBox">?</div><span>=</span><span>${p.b}</span></div>`;
    }
    else {
      // Standard Eq: a + b = ?
      content += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span><span>${p.b}</span><span>=</span><div id="ansBox" class="eqBox">?</div></div>`;
    }

    body.innerHTML = content;
    renderKeypad();
  }

  function renderKeypad() {
    const kbd = document.getElementById('uiKbd');
    kbd.innerHTML = "";

    if(current.type === 'cmp') {
      ['<', '=', '>'].forEach(s => {
        const b = document.createElement('button');
        b.className = 'btn'; b.innerText = s;
        b.onclick = () => check(s);
        kbd.appendChild(b);
      });
      // Add a skip button
      const skp = document.createElement('button'); skp.className='btn ghost'; skp.innerText='SchimbƒÉ'; 
      skp.onclick=newRound; skp.style.gridColumn = "span 3";
      kbd.appendChild(skp);
    } else {
      [1,2,3,4,5,6,7,8,9].forEach(n => {
        const b = document.createElement('button');
        b.className = 'btn'; b.innerText = n;
        b.onclick = () => onInput(n);
        kbd.appendChild(b);
      });
      // Bottom row
      const bDel = document.createElement('button'); bDel.className='btn warn small'; bDel.innerText='‚å´';
      bDel.onclick = () => onInput('del');
      kbd.appendChild(bDel);

      const b0 = document.createElement('button'); b0.className='btn'; b0.innerText='0';
      b0.onclick = () => onInput(0);
      kbd.appendChild(b0);

      const bOk = document.createElement('button'); bOk.className='btn primary small'; bOk.innerText='OK';
      bOk.onclick = () => check(inputBuf);
      kbd.appendChild(bOk);
    }
  }

  function onInput(v) {
    SFX.click();
    if(v === 'del') inputBuf = inputBuf.slice(0, -1);
    else if(inputBuf.length < 2) inputBuf += v;
    
    const box = document.getElementById('ansBox');
    box.innerText = inputBuf || "?";
    if(inputBuf) box.classList.add('filled'); else box.classList.remove('filled');
  }

  // --- INTERFACE EXPORTS ---
  return {
    init,
    setLevel: (l) => { state.settings.level = l; save(); renderStats(); renderSkills(); newRound(); },
    toggleSound: () => { state.settings.sound = SFX.toggle(); renderStats(); },
    makeEasier,
    newRound,
    
    // Parent Gate
    parentGate: () => {
      document.getElementById('pinMsg').innerText = "";
      document.getElementById('pinInput').value = "";
      document.getElementById('pinDlg').showModal();
      setTimeout(()=>document.getElementById('pinInput').focus(),100);
    },
    
    // Parent Actions
    resetAll: () => { if(confirm("»òtergi tot?")) { localStorage.removeItem(KEY); location.reload(); } },
    giveCoins: () => { state.economy.coins+=50; save(); renderStats(); toast("+50 ü™ô"); },
    changePin: async () => {
      const p = prompt("PIN Nou (4-8 cifre):");
      if(p && p.length>=4) {
        state.security.salt = SEC.salt();
        state.security.hash = await SEC.hash(p, state.security.salt);
        save(); toast("PIN Schimbat");
      }
    },
    exportData: () => {
      document.getElementById('stateDump').value = JSON.stringify(state, null, 2);
      const b = new Blob([JSON.stringify(state)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='marclab-backup.json';
      a.click();
    },
    importData: (el) => {
      const f = el.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = (e) => {
        try {
          const s = JSON.parse(e.target.result);
          if(s.meta && s.skills) { state=s; save(); location.reload(); }
        } catch(err) { alert("Eroare fi»ôier"); }
      };
      r.readAsText(f);
    }
  };
})();

// PIN Dialog Events
document.getElementById('pinOk').onclick = async () => {
  const inp = document.getElementById('pinInput').value;
  const hash = await SEC.hash(inp, JSON.parse(localStorage.getItem('marclab-plusminus-v2-1')).security.salt);
  if(hash === JSON.parse(localStorage.getItem('marclab-plusminus-v2-1')).security.hash) {
    document.getElementById('pinDlg').close();
    document.getElementById('parentDlg').showModal();
  } else {
    document.getElementById('pinMsg').innerText = "PIN Incorect";
  }
};

app.init();
</script>
</body>
</html>
