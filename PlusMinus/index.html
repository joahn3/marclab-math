<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MarcLab ‚Üí PlusMinus (v2.7 Stable)</title>
  <style>
    :root {
      /* --- TEMA COSMICƒÇ --- */
      --bg: #0f172a; --card: #1e293b; --line: rgba(255,255,255,0.1);
      --text: #f1f5f9; --muted: #94a3b8;
      --accent: #38bdf8; --accent-dim: rgba(56, 189, 248, 0.15);
      --gold: #facc15; --good: #4ade80; --bad: #fb7185; --warn: #fbbf24;
      --shadow: 0 12px 30px rgba(0,0,0,0.5); --radius: 22px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    body {
      margin: 0; font-family: var(--font);
      background: radial-gradient(circle at 15% 10%, rgba(124, 58, 237, 0.15) 0%, transparent 40%),
                  radial-gradient(circle at 85% 80%, rgba(56, 189, 248, 0.1) 0%, transparent 40%), var(--bg);
      color: var(--text); min-height: 100vh; display: flex; align-items: stretch; justify-content: center; padding: 18px;
    }
    .app { width: min(980px, 100%); display: flex; flex-direction: column; gap: 16px; }

    /* UI Components */
    .top {
      display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: space-between;
      background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(10px);
      padding: 12px 16px; border-radius: var(--radius); border: 1px solid var(--line);
    }
    .brand b { font-size: 18px; color: var(--accent); letter-spacing: -0.02em; }
    .brand span { font-size: 12px; color: var(--muted); display:block;}
    .pill-btn {
      background: rgba(255,255,255,0.05); border: 1px solid var(--line); color: var(--muted);
      padding: 8px 14px; border-radius: 99px; font-size: 13px; font-weight: 700; cursor: pointer;
    }
    .pill-btn.active { background: var(--accent); color: #0f172a; border-color: var(--accent); }
    .stat {
      padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 99px; border: 1px solid var(--line);
      font-size: 13px; font-weight: 700; display: flex; gap: 6px; align-items: center;
    }
    .stat.gold { color: var(--gold); border-color: rgba(250, 204, 21, 0.2); }

    .main { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 16px; }
    @media (max-width: 880px) { .main { grid-template-columns: 1fr; } }

    .card {
      background: var(--card); border: 1px solid var(--line); border-radius: var(--radius);
      box-shadow: var(--shadow); padding: 20px; position: relative; overflow: hidden;
    }
    .prompt { display: flex; flex-direction: column; gap: 16px; min-height: 480px; justify-content: space-between; }

    /* Visuals */
    .viz-area { display: flex; justify-content: center; gap: 20px; margin-bottom: 10px; min-height: 50px; }
    .ten-frame {
      display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(2, 1fr);
      gap: 6px; padding: 8px; border: 2px solid var(--muted); border-radius: 10px; background: rgba(0,0,0,0.2);
    }
    .tf-dot { width: 16px; height: 16px; border-radius: 50%; border: 1px dashed rgba(255,255,255,0.1); }
    .tf-dot.filled { background: var(--good); border: none; box-shadow: 0 0 8px var(--good); }
    
    .dot-group { display: flex; gap: 6px; flex-wrap: wrap; max-width: 80px; justify-content: center; align-content: center; }
    .d-pt { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; opacity: 0.9; box-shadow: 0 0 6px var(--accent-dim); }

    /* Problem */
    .problem-header { display: flex; justify-content: space-between; align-items: center; }
    .h-text { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--muted); letter-spacing: 1px; }
    .problem-body { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; min-height: 120px; }
    .big-eq {
      font-size: 56px; font-weight: 900; line-height: 1.1; display: flex; align-items: center;
      gap: 14px; flex-wrap: wrap; justify-content: center; text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .eqBox {
      min-width: 100px; height: 86px; padding: 0 20px; border-radius: 18px; border: 2px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.3); color: var(--accent); display: flex; align-items: center; justify-content: center;
    }
    .eqBox.filled { border-color: var(--accent); background: var(--accent-dim); }

    /* Keypad */
    .kbd { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 400px; width: 100%; margin: 0 auto; }
    .btn {
      border: 1px solid var(--line); background: rgba(255,255,255,0.05); color: var(--text);
      padding: 16px; border-radius: 16px; font-size: 24px; font-weight: 700; cursor: pointer;
      box-shadow: 0 4px 0 rgba(0,0,0,0.3); transition: transform 0.1s;
    }
    .btn:active { transform: translateY(4px); box-shadow: none; }
    .btn.small { font-size: 16px; padding: 12px; }
    .btn.warn { background: rgba(251,191,36,0.15); border-color: rgba(251,191,36,0.3); color: var(--warn); }
    .btn.primary { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .btn.ghost { background: transparent; border: none; box-shadow: none; color: var(--muted); font-size: 14px; }

    /* Feedback */
    .feedback {
      position: absolute; inset: 0; background: rgba(15,23,42,0.95); backdrop-filter: blur(8px);
      display: none; flex-direction: column; align-items: center; justify-content: center; gap: 10px; z-index: 10;
    }
    .btn-next {
      margin-top: 20px; background: var(--good); color: #064e3b; border: none;
      padding: 14px 40px; font-size: 20px; font-weight: 800; border-radius: 99px; cursor: pointer;
      box-shadow: 0 0 20px rgba(74,222,128,0.4);
    }

    /* Side & Dialogs */
    .skill-item { padding: 10px 0; border-bottom: 1px solid var(--line); }
    .meter { height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; }
    .fill { height: 100%; background: var(--accent); transition: width 0.5s; }

    dialog {
      background: var(--card); color: var(--text); border: 1px solid var(--line);
      border-radius: 20px; padding: 24px; width: min(500px, 90vw); box-shadow: 0 20px 60px rgba(0,0,0,0.8);
    }
    dialog::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
    .pinInput {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--line); color: white;
      padding: 14px; font-size: 24px; letter-spacing: 0.5em; text-align: center; border-radius: 12px; margin: 16px 0;
    }
    textarea { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--line); color: var(--muted); border-radius: 12px; min-height: 100px; padding: 10px; font-family: monospace;}
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--gold); color: #422006; font-weight: 800; padding: 10px 24px; border-radius: 99px;
      z-index: 100; box-shadow: 0 10px 30px rgba(250, 204, 21, 0.4); display: none;
    }
  </style>
</head>
<body>

  <div class="app">
    <div class="top">
      <div class="brand"><b>MarcLab ‚Üí PlusMinus</b><span>v2.7 Stable</span></div>
      <div class="controls">
        <button class="pill-btn active" id="btnLvl1" onclick="app.setLevel(1)">L1: 1‚Äì10</button>
        <button class="pill-btn" id="btnLvl2" onclick="app.setLevel(2)">L2: 10‚Äì20</button>
        <button class="pill-btn" onclick="app.toggleSound()" id="btnSound">üîä</button>
      </div>
      <div class="stats">
        <div class="stat">XP <span id="uiXp">0</span></div>
        <div class="stat gold">ü™ô <span id="uiCoins">0</span></div>
        <div class="stat">üî• <span id="uiStreak">0</span></div>
      </div>
    </div>

    <div class="main">
      <div class="card prompt">
        <div class="problem-header">
          <div class="h-text" id="uiSkillName">√éNCƒÇRCARE...</div>
          <button class="btn ghost" onclick="app.makeEasier()">Prea greu?</button>
        </div>
        
        <div class="problem-body" id="uiProblem"></div>
        
        <div class="kbd" id="kbd"></div>

        <div class="feedback" id="uiFeedback">
          <div class="fb-icon" id="fbIcon" style="font-size:64px">‚≠ê</div>
          <div style="font-size:24px; font-weight:800" id="fbTitle">Corect!</div>
          <div style="color:var(--muted)" id="fbSub">+10 XP</div>
          <button class="btn-next" onclick="app.newRound()" id="btnNext">UrmƒÉtorul</button>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div class="card">
          <div class="h-text" style="margin-bottom:12px">AbilitƒÉ»õi (Adaptiv)</div>
          <div id="uiSkills"></div>
        </div>
        <div class="card">
          <div class="h-text" style="margin-bottom:12px">Control PƒÉrinte</div>
          <button class="btn small primary" style="width:100%" onclick="app.parentGate()">Dashboard üîí</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Notificare</div>

  <dialog id="pinDlg">
    <h3>Introducere PIN</h3>
    <input id="pinInput" class="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div id="pinMsg" style="color:var(--bad); font-weight:700; height:20px; font-size:13px"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
      <button class="btn small" onclick="document.getElementById('pinDlg').close()">AnuleazƒÉ</button>
      <button class="btn small primary" id="pinOk">ConfirmƒÉ</button>
    </div>
  </dialog>

  <dialog id="parentDlg">
    <h3>Dashboard PƒÉrinte</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin: 16px 0;">
      <button class="btn small warn" onclick="app.resetAll()">Reset TOTAL</button>
      <button class="btn small" onclick="app.giveCoins()">+50 Coins</button>
      <button class="btn small" onclick="app.changePin()">SchimbƒÉ PIN</button>
      <button class="btn small" onclick="app.exportData()">Export JSON</button>
      <label class="btn small" style="display:flex;align-items:center;justify-content:center;cursor:pointer">
        Import
        <input type="file" onchange="app.importData(this)" style="display:none" accept=".json">
      </label>
    </div>
    <div class="h-text">Date Brute</div>
    <textarea id="stateDump" readonly></textarea>
    <div style="display:flex; justify-content:flex-end; margin-top:12px">
      <button class="btn small primary" onclick="document.getElementById('parentDlg').close()">√énchide</button>
    </div>
  </dialog>

<script>
/**
 * MarcLab ‚Üí PlusMinus v2.7 Stable
 * Fixes: Render Loop, Audio Sync, Safe Error Handler, Fresh Key
 */

// --- SAFE ERROR HANDLER (Anti-Loop) ---
window.onerror = function() {
  try {
    if (sessionStorage.getItem("ml_recovered") === "1") {
      // Stop loop if already tried to recover
      alert("MarcLab a √Ænt√¢mpinat o eroare criticƒÉ. Te rog reseteazƒÉ progresul din Dashboard.");
      return true; 
    }
    sessionStorage.setItem("ml_recovered", "1");
    // Clear ONLY our keys
    localStorage.removeItem("marclab-plusminus-v2-7");
    localStorage.removeItem("marclab-plusminus-l1-v1");
  } catch(e){}
  
  location.reload();
  return true;
};

const SFX = (() => {
  let ctx=null, enabled=true;
  function init(){ if(!ctx) ctx=new(window.AudioContext||window.webkitAudioContext)(); }
  function play(f,t,d,v=0.1){
    if(!enabled||!ctx)return; const o=ctx.createOscillator(),g=ctx.createGain();
    o.type=t; o.frequency.setValueAtTime(f,ctx.currentTime);
    g.gain.setValueAtTime(v,ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01,ctx.currentTime+d);
    o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d);
  }
  return {
    toggle:()=>{enabled=!enabled; if(enabled)init(); return enabled;},
    correct:()=>{init(); play(523,'sine',0.1); setTimeout(()=>play(784,'sine',0.3),100);},
    wrong:()=>{init(); play(150,'sawtooth',0.3,0.2); setTimeout(()=>play(120,'sawtooth',0.3,0.2),150);},
    click:()=>{init(); play(800,'sine',0.05,0.03);}
  };
})();

const SEC = {
  salt:()=>Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''),
  hash:async(p,s)=>{
    const b=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(p+":"+s));
    return Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('');
  }
};

const app = (() => {
  const KEY = 'marclab-plusminus-v2-7'; // Fresh Key
  const KEY_LEGACY = 'marclab-plusminus-l1-v1';
  const DEFAULT_PIN = "2580";

  function defaultState() {
    return {
      meta: { ver: 2.7, app: "PlusMinus" },
      settings: { level: 1, sound: true },
      security: { salt: "", hash: "" },
      economy: { xp: 0, coins: 0, streak: 0, level: 1 },
      skills: {
        add1: { n:"AdunƒÉri (1-10)", l:1, m:0.5 }, sub1: { n:"ScƒÉderi (1-10)", l:1, m:0.5 },
        mk10: { n:"P√¢nƒÉ la 10", l:1, m:0.4 }, cnt: { n:"NumƒÉrƒÉ", l:1, m:0.5 },
        cmp1: { n:"ComparƒÉ (1-10)", l:1, m:0.5 },
        add2: { n:"AdunƒÉri (10-20)", l:1, m:0.3 }, sub2: { n:"ScƒÉderi (10-20)", l:1, m:0.3 },
        cmp2: { n:"ComparƒÉ (10-20)", l:1, m:0.4 }
      },
      history: []
    };
  }

  let state = defaultState();
  let current = null;
  let locked = false;
  let inputBuf = "";

  const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
  
  const save = () => {
    localStorage.setItem(KEY, JSON.stringify(state));
    const summary = {
      meta: { brand:"MarcLab", module:"PlusMinus", version:"2.7", updatedAt: Date.now() },
      economy: { xp: state.economy.xp, coins: state.economy.coins, streak: state.economy.streak, level: state.economy.level },
      skills: {
        add: { name:"AdunƒÉri", level:1, mastery: state.skills.add1?.m||0 },
        sub: { name:"ScƒÉderi", level:1, mastery: state.skills.sub1?.m||0 },
        make10: { name:"P√¢nƒÉ la 10", level:1, mastery: state.skills.mk10?.m||0 }
      }
    };
    localStorage.setItem(KEY_LEGACY, JSON.stringify(summary));
  };

  const toast = (msg) => {
    const t = document.getElementById('toast');
    t.innerText = msg; t.style.display = "block"; setTimeout(()=>t.style.display="none", 2000);
  };

  async function init() {
    const raw = localStorage.getItem(KEY);
    if(raw) { 
      try { 
        const s = JSON.parse(raw);
        // Deep Merge to fill missing keys
        state = { ...defaultState(), ...s };
        state.skills = { ...defaultState().skills, ...s.skills };
        state.settings = { ...defaultState().settings, ...s.settings };
      } catch(e) { console.warn("Resetting corrupted state"); } 
    }
    
    // Security Init
    if(!state.security.salt) {
      state.security.salt = SEC.salt();
      state.security.hash = await SEC.hash(DEFAULT_PIN, state.security.salt);
      save();
    }

    // Audio Sync Fix
    if(state.settings.sound === false) {
       SFX.toggle(); // Disable SFX because it defaults to true
    }

    // Success - Clear recovery flag
    sessionStorage.removeItem("ml_recovered");

    // Init UI
    renderStats(); 
    newRound();
  }

  function pickSkill() {
    const set = state.settings.level===1 ? ['add1', 'sub1', 'mk10', 'cnt', 'cmp1'] : ['add2', 'sub2', 'cmp2'];
    const weights = set.map(k => {
      const s = state.skills[k];
      return { k, w: s ? (1 - s.m) + 0.2 : 1 }; 
    });
    const sum = weights.reduce((a,b)=>a+b.w, 0);
    let r = Math.random() * sum;
    for(let i of weights) { r-=i.w; if(r<=0) return i.k; }
    return set[0];
  }

  function genProblem() {
    const skKey = pickSkill();
    const sk = state.skills[skKey] || { n:"Exerci»õiu", l:1, m:0.5 }; 
    let p = { skill: skKey, type: 'numpad', viz: null, txt: sk.n };

    if(skKey === 'cnt') {
      const n = rand(3, 10); p.ans = n; p.viz = 'dots_only'; p.a = n; p.txt = "C√¢te puncte sunt?";
    } else if(skKey === 'mk10') {
      const a = rand(1, 9); p.a = a; p.b = 10; p.ans = 10-a; p.op = '+'; p.viz = 'tenframe'; p.mode = 'missing'; p.txt = "C√¢t lipse»ôte p√¢nƒÉ la 10?";
    } else if(skKey === 'cmp1') {
      const a = rand(1, 10), b = rand(1, 10); p.a = a; p.b = b; p.ans = a===b?'=':(a>b?'>':'<'); p.type = 'cmp';
    } else if(skKey === 'cmp2') {
      const a = rand(10, 20), b = rand(10, 20); if(a===b) return genProblem();
      p.a = a; p.b = b; p.ans = a>b?'>':'<'; p.type = 'cmp';
    } else if(skKey === 'add1') {
      const a = rand(1, 8), b = rand(1, 9-a); p.a = a; p.b = b; p.op = '+'; p.ans = a+b; p.viz = 'dots_help';
    } else if(skKey === 'sub1') {
      const a = rand(2, 9), b = rand(1, a); p.a = a; p.b = b; p.op = '‚àí'; p.ans = a-b; p.viz = 'dots_help';
    } else if(skKey === 'add2') {
      const a = rand(6, 9), b = rand(11-a, 9); p.a = a; p.b = b; p.op = '+'; p.ans = a+b;
    } else if(skKey === 'sub2') {
      const a = rand(11, 18), b = rand(a-9, 9); p.a = a; p.b = b; p.op = '‚àí'; p.ans = a-b;
    }
    return p;
  }

  function newRound() {
    locked = false; inputBuf = "";
    document.getElementById('uiFeedback').style.display = "none";
    try {
      current = genProblem(); renderProblem();
    } catch(e) {
      console.error(e);
      // Fail gracefully -> recover via reload
      localStorage.removeItem(KEY); location.reload();
    }
  }

  function check(val) {
    if(locked || val === "") return;
    locked = true;
    let correct = false;
    if(current.type === 'cmp') correct = String(val) === String(current.ans);
    else correct = Number(val) === Number(current.ans);

    const sk = state.skills[current.skill] || {m:0.5};

    if(correct) {
      SFX.correct(); state.economy.xp += 10; state.economy.streak++;
      sk.m = Math.min(0.99, sk.m + 0.05);
      if(state.economy.streak % 5 === 0) { state.economy.coins += 5; toast("Streak Bonus! +5 ü™ô"); }
    } else {
      SFX.wrong(); state.economy.streak = 0;
      sk.m = Math.max(0.1, sk.m - 0.04);
    }
    if(state.skills[current.skill]) state.skills[current.skill] = sk;
    save(); renderStats();

    const fb = document.getElementById('uiFeedback'); fb.style.display = "flex";
    const title = document.getElementById('fbTitle'); const btn = document.getElementById('btnNext');
    if(correct) {
      document.getElementById('fbIcon').innerText = "‚≠ê"; title.innerText = "Corect!"; title.style.color = "var(--good)";
      document.getElementById('fbSub').innerText = "+10 XP"; btn.style.background = "var(--good)"; btn.innerText = "ContinuƒÉ";
    } else {
      document.getElementById('fbIcon').innerText = "‚ùå"; title.innerText = "Gre»ôit"; title.style.color = "var(--bad)";
      document.getElementById('fbSub').innerText = `RƒÉspunsul era: ${current.ans}`; btn.style.background = "var(--warn)"; btn.innerText = "Am √Æn»õeles";
    }
  }

  function makeEasier() {
    const sk = state.skills[current.skill];
    if(sk) { sk.m = Math.max(0.1, sk.m - 0.1); save(); }
    toast("Am simplificat pu»õin."); newRound();
  }

  function getDots(n) {
    let s=''; for(let i=0;i<n;i++) s+='<div class="d-pt"></div>'; return s;
  }
  function getFrame(n) {
    let s='<div class="ten-frame">'; for(let i=1;i<=10;i++) s+=`<div class="tf-dot ${i<=n?'filled':''}"></div>`; return s+'</div>';
  }

  function renderProblem() {
    const p = current; document.getElementById('uiSkillName').innerText = p.txt;
    const body = document.getElementById('uiProblem');
    let h = "";
    
    if(p.viz === 'tenframe') h += `<div class="viz-area">${getFrame(p.a)}</div>`;
    else if(p.viz === 'dots_only') h += `<div class="viz-area"><div class="dot-group">${getDots(p.a)}</div></div>`;
    else if(p.viz === 'dots_help') h += `<div class="viz-area"><div class="dot-group">${getDots(p.a)}</div><div style="width:20px"></div><div class="dot-group">${getDots(p.b)}</div></div>`;

    const box = `<div id="ansBox" class="eqBox">?</div>`;
    if(p.type === 'cmp') h += `<div class="big-eq"><span>${p.a}</span>${box}<span>${p.b}</span></div>`;
    else if(p.mode === 'missing') h += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span>${box}<span>=</span><span>${p.b}</span></div>`;
    else if(p.viz === 'dots_only') h += `<div class="big-eq">${box}</div>`;
    else h += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span><span>${p.b}</span><span>=</span>${box}</div>`;
    
    body.innerHTML = h;
    renderKeypad();
  }

  function renderKeypad() {
    const kbd = document.getElementById('kbd'); kbd.innerHTML = "";
    if(current.type === 'cmp') {
      ['<','=','>'].forEach(s=>{ const b=document.createElement('button'); b.className='btn'; b.innerText=s; b.onclick=()=>check(s); kbd.appendChild(b); });
      const skp=document.createElement('button'); skp.className='btn ghost'; skp.innerText='SchimbƒÉ'; skp.onclick=newRound; skp.style.gridColumn="span 3"; kbd.appendChild(skp);
    } else {
      [1,2,3,4,5,6,7,8,9].forEach(n=>{ const b=document.createElement('button'); b.className='btn'; b.innerText=n; b.onclick=()=>onInput(n); kbd.appendChild(b); });
      const del=document.createElement('button'); del.className='btn warn small'; del.innerText='‚å´'; del.onclick=()=>onInput('del'); kbd.appendChild(del);
      const b0=document.createElement('button'); b0.className='btn'; b0.innerText='0'; b0.onclick=()=>onInput(0); kbd.appendChild(b0);
      const ok=document.createElement('button'); ok.className='btn primary small'; ok.innerText='OK'; ok.onclick=()=>check(inputBuf); kbd.appendChild(ok);
    }
  }

  function onInput(v) {
    SFX.click();
    if(v==='del') inputBuf=inputBuf.slice(0,-1);
    else if(inputBuf.length<2) inputBuf+=v;
    const box=document.getElementById('ansBox'); box.innerText=inputBuf||"?";
    if(inputBuf) box.classList.add('filled'); else box.classList.remove('filled');
  }

  function renderStats() {
    document.getElementById('uiXp').innerText = state.economy.xp;
    document.getElementById('uiCoins').innerText = state.economy.coins;
    document.getElementById('uiStreak').innerText = state.economy.streak;
    document.getElementById('btnLvl1').classList.toggle('active', state.settings.level===1);
    document.getElementById('btnLvl2').classList.toggle('active', state.settings.level===2);
    document.getElementById('btnSound').style.opacity = state.settings.sound ? 1 : 0.5;
    
    // Skills Rendering inside Stats
    const skBox = document.getElementById('uiSkills'); skBox.innerHTML = "";
    const list = state.settings.level===1?['add1','sub1','mk10','cnt','cmp1']:['add2','sub2','cmp2'];
    list.forEach(k=>{
      if(state.skills[k]) {
        const pct=Math.round(state.skills[k].m*100);
        skBox.innerHTML += `<div class="skill-item"><div class="skill-top"><span>${state.skills[k].n}</span><span>${pct}%</span></div><div class="meter"><div class="fill" style="width:${pct}%"></div></div></div>`;
      }
    });
  }

  return {
    init, setLevel:(l)=>{state.settings.level=l; save(); renderStats(); newRound();},
    toggleSound:()=>{state.settings.sound=SFX.toggle(); renderStats();},
    makeEasier, newRound,
    parentGate:()=>{ document.getElementById('pinMsg').innerText=""; document.getElementById('pinInput').value=""; document.getElementById('pinDlg').showModal(); setTimeout(()=>document.getElementById('pinInput').focus(),100); },
    resetAll:()=>{ if(confirm("»òtergi tot?")) { localStorage.removeItem(KEY); localStorage.removeItem(KEY_LEGACY); location.reload(); } },
    giveCoins:()=>{ state.economy.coins+=50; save(); renderStats(); toast("+50 ü™ô"); },
    changePin:async()=>{ const p=prompt("PIN Nou:"); if(p&&p.length>=4){ state.security.salt=SEC.salt(); state.security.hash=await SEC.hash(p,state.security.salt); save(); toast("PIN Schimbat"); } },
    exportData:()=>{ document.getElementById('stateDump').value=JSON.stringify(state,null,2); const b=new Blob([JSON.stringify(state)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='marclab_v2.json'; a.click(); },
    importData:(el)=>{ const f=el.files[0]; if(!f)return; const r=new FileReader(); r.onload=(e)=>{ try{ const s=JSON.parse(e.target.result); if(s.meta && s.skills){ state=s; save(); location.reload(); } }catch(e){alert("Eroare");} }; r.readAsText(f); },
    getState: () => state,
    getHash: SEC.hash
  };
})();

document.getElementById('pinOk').onclick = async () => {
  const inp = document.getElementById('pinInput').value.trim();
  const st = app.getState();
  if(!st || !st.security || !st.security.hash) { document.getElementById('pinMsg').innerText = "Eroare date."; return; }
  const computed = await app.getHash(inp, st.security.salt);
  if(computed === st.security.hash) {
    document.getElementById('pinDlg').close();
    document.getElementById('stateDump').value = JSON.stringify(st, null, 2);
    document.getElementById('parentDlg').showModal();
  } else {
    document.getElementById('pinMsg').innerText = "PIN Incorect";
  }
};

app.init();
</script>
</body>
</html>
