<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MarcLab ‚Üí PlusMinus (v2.6.1 Stable)</title>
  <meta name="description" content="MarcLab PlusMinus v2.6.1. Crash-safe recovery (no infinite reload), state normalization, sound state sync, PIN gate." />
  <style>
    :root{
      --bg:#0f172a; --card:#1e293b; --line:rgba(255,255,255,.1);
      --text:#f1f5f9; --muted:#94a3b8;
      --accent:#38bdf8; --accent-dim:rgba(56,189,248,.15);
      --gold:#facc15; --good:#4ade80; --bad:#fb7185; --warn:#fbbf24;
      --shadow:0 12px 30px rgba(0,0,0,.5); --radius:22px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    }
    *{box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent;}
    body{
      margin:0; font-family:var(--font);
      background:
        radial-gradient(circle at 15% 10%, rgba(124,58,237,.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 80%, rgba(56,189,248,.1) 0%, transparent 40%),
        var(--bg);
      color:var(--text);
      min-height:100vh; display:flex; align-items:stretch; justify-content:center;
      padding:18px;
    }
    .app{width:min(980px,100%); display:flex; flex-direction:column; gap:16px;}
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      background:rgba(30,41,59,.6); backdrop-filter:blur(10px);
      padding:12px 16px; border-radius:var(--radius); border:1px solid var(--line);
    }
    .brand b{font-size:18px; color:var(--accent); letter-spacing:-.02em;}
    .brand span{font-size:12px; color:var(--muted); display:block;}
    .controls{display:flex; gap:8px; align-items:center;}
    .pill-btn{
      background:rgba(255,255,255,.05); border:1px solid var(--line); color:var(--muted);
      padding:8px 14px; border-radius:99px; font-size:13px; font-weight:700; cursor:pointer;
    }
    .pill-btn.active{background:var(--accent); color:#0f172a; border-color:var(--accent);}
    .stats{display:flex; gap:10px; align-items:center;}
    .stat{
      padding:6px 12px; background:rgba(0,0,0,.3); border-radius:99px; border:1px solid var(--line);
      font-size:13px; font-weight:700; display:flex; gap:6px; align-items:center;
    }
    .stat.gold{color:var(--gold); border-color:rgba(250,204,21,.2);}

    .main{display:grid; grid-template-columns:1.3fr .7fr; gap:16px;}
    @media(max-width:880px){.main{grid-template-columns:1fr;}}

    .card{
      background:var(--card); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:20px; position:relative; overflow:hidden;
    }
    .prompt{display:flex; flex-direction:column; gap:16px; min-height:480px; justify-content:space-between;}

    .problem-header{display:flex; justify-content:space-between; align-items:center;}
    .h-text{font-size:13px; font-weight:700; text-transform:uppercase; color:var(--muted); letter-spacing:1px;}
    .problem-body{
      flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:10px; min-height:120px;
    }

    /* Visuals */
    .viz-area{display:flex; justify-content:center; gap:20px; margin-bottom:10px; min-height:50px;}
    .ten-frame{
      display:grid; grid-template-columns:repeat(5,1fr); grid-template-rows:repeat(2,1fr);
      gap:6px; padding:8px; border:2px solid var(--muted); border-radius:10px; background:rgba(0,0,0,.2);
    }
    .tf-dot{width:16px; height:16px; border-radius:50%; border:1px dashed rgba(255,255,255,.1);}
    .tf-dot.filled{background:var(--good); border:none; box-shadow:0 0 8px var(--good);}

    .dot-group{display:flex; gap:6px; flex-wrap:wrap; max-width:80px; justify-content:center; align-content:center;}
    .d-pt{width:12px; height:12px; background:var(--accent); border-radius:50%; opacity:.9; box-shadow:0 0 6px var(--accent-dim);}

    .big-eq{
      font-size:56px; font-weight:900; line-height:1.1;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap; justify-content:center;
      text-shadow:0 4px 20px rgba(0,0,0,.5);
    }
    .eqBox{
      min-width:100px; height:86px; padding:0 20px;
      border-radius:18px; border:2px solid rgba(255,255,255,.2);
      background:rgba(0,0,0,.3); color:var(--accent);
      display:flex; align-items:center; justify-content:center;
    }
    .eqBox.filled{border-color:var(--accent); background:var(--accent-dim);}

    /* Keypad */
    .kbd{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; max-width:400px; width:100%; margin:0 auto;}
    .btn{
      border:1px solid var(--line); background:rgba(255,255,255,.05); color:var(--text);
      padding:16px; border-radius:16px; font-size:24px; font-weight:700; cursor:pointer;
      box-shadow:0 4px 0 rgba(0,0,0,.3); transition:transform .1s;
    }
    .btn:active{transform:translateY(4px); box-shadow:none;}
    .btn.small{font-size:16px; padding:12px;}
    .btn.warn{background:rgba(251,191,36,.15); border-color:rgba(251,191,36,.3); color:var(--warn);}
    .btn.primary{background:var(--accent-dim); border-color:var(--accent); color:var(--accent);}
    .btn.ghost{background:transparent; border:none; box-shadow:none; color:var(--muted); font-size:14px;}

    /* Feedback */
    .feedback{
      position:absolute; inset:0; background:rgba(15,23,42,.95); backdrop-filter:blur(8px);
      display:none; flex-direction:column; align-items:center; justify-content:center; gap:10px; z-index:10;
    }
    .btn-next{
      margin-top:20px; background:var(--good); color:#064e3b; border:none;
      padding:14px 40px; font-size:20px; font-weight:800; border-radius:99px; cursor:pointer;
      box-shadow:0 0 20px rgba(74,222,128,.4);
    }

    /* Side */
    .skill-item{padding:10px 0; border-bottom:1px solid var(--line);}
    .skill-top{display:flex; justify-content:space-between; font-size:13px; font-weight:700; margin-bottom:6px;}
    .meter{height:6px; background:rgba(255,255,255,.1); border-radius:99px; overflow:hidden;}
    .fill{height:100%; background:var(--accent); transition:width .5s;}

    /* Dialogs */
    dialog{
      background:var(--card); color:var(--text); border:1px solid var(--line);
      border-radius:20px; padding:24px; width:min(500px,90vw);
      box-shadow:0 20px 60px rgba(0,0,0,.8);
    }
    dialog::backdrop{background:rgba(0,0,0,.7); backdrop-filter:blur(4px);}
    .pinInput{
      width:100%; background:rgba(0,0,0,.3); border:1px solid var(--line); color:#fff;
      padding:14px; font-size:24px; letter-spacing:.5em; text-align:center; border-radius:12px; margin:16px 0;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }
    textarea{
      width:100%; background:rgba(0,0,0,.3); border:1px solid var(--line); color:var(--muted);
      border-radius:12px; min-height:100px; padding:10px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    }

    /* Toast */
    .toast{
      position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
      background:var(--gold); color:#422006; font-weight:800;
      padding:10px 24px; border-radius:99px; z-index:100;
      box-shadow:0 10px 30px rgba(250,204,21,.4);
      display:none;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <div class="brand">
        <b>MarcLab ‚Üí PlusMinus</b>
        <span>v2.6.1 Stable ‚Ä¢ anti-crash + state normalize</span>
      </div>

      <div class="controls">
        <button class="pill-btn active" id="btnLvl1" onclick="app.setLevel(1)">L1: 1‚Äì10</button>
        <button class="pill-btn" id="btnLvl2" onclick="app.setLevel(2)">L2: 10‚Äì20</button>
        <button class="pill-btn" onclick="app.toggleSound()" id="btnSound">üîä</button>
      </div>

      <div class="stats">
        <div class="stat">XP <span id="uiXp">0</span></div>
        <div class="stat gold">ü™ô <span id="uiCoins">0</span></div>
        <div class="stat">üî• <span id="uiStreak">0</span></div>
      </div>
    </div>

    <div class="main">
      <div class="card prompt">
        <div class="problem-header">
          <div class="h-text" id="uiSkillName">√éNCƒÇRCARE...</div>
          <button class="btn ghost" onclick="app.makeEasier()">Prea greu?</button>
        </div>

        <div class="problem-body" id="uiProblem"></div>

        <div class="kbd" id="kbd"></div>

        <div class="feedback" id="uiFeedback">
          <div id="fbIcon" style="font-size:64px">‚≠ê</div>
          <div id="fbTitle" style="font-size:24px; font-weight:800">Corect!</div>
          <div id="fbSub" style="color:var(--muted)">+10 XP</div>
          <button class="btn-next" onclick="app.newRound()" id="btnNext">UrmƒÉtorul</button>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:16px;">
        <div class="card">
          <div class="h-text" style="margin-bottom:12px">AbilitƒÉ»õi (Adaptiv)</div>
          <div id="uiSkills"></div>
        </div>

        <div class="card">
          <div class="h-text" style="margin-bottom:12px">Control PƒÉrinte</div>
          <button class="btn small primary" style="width:100%" onclick="app.parentGate()">Dashboard üîí</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Notificare</div>

  <dialog id="pinDlg">
    <h3>Introducere PIN</h3>
    <p style="color:var(--muted); margin:0">Pentru a accesa setƒÉrile.</p>
    <input id="pinInput" class="pinInput" type="password" inputmode="numeric" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    <div id="pinMsg" style="color:var(--bad); font-weight:700; height:20px; font-size:13px"></div>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px">
      <button class="btn small" onclick="safeCloseDialog('pinDlg')">AnuleazƒÉ</button>
      <button class="btn small primary" id="pinOk">ConfirmƒÉ</button>
    </div>
  </dialog>

  <dialog id="parentDlg">
    <h3>Dashboard PƒÉrinte</h3>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:16px 0;">
      <button class="btn small warn" onclick="app.resetAll()">Reset TOTAL</button>
      <button class="btn small" onclick="app.giveCoins()">+50 Coins</button>
      <button class="btn small" onclick="app.changePin()">SchimbƒÉ PIN</button>
      <button class="btn small" onclick="app.exportData()">Export JSON</button>
      <label class="btn small" style="display:flex;align-items:center;justify-content:center;cursor:pointer">
        Import
        <input type="file" onchange="app.importData(this)" style="display:none" accept=".json">
      </label>
    </div>
    <div class="h-text">Date Brute</div>
    <textarea id="stateDump" readonly></textarea>
    <div style="display:flex; justify-content:flex-end; margin-top:12px">
      <button class="btn small primary" onclick="safeCloseDialog('parentDlg')">√énchide</button>
    </div>
  </dialog>

<script>
/**
 * MarcLab ‚Üí PlusMinus v2.6.1 Stable
 * Fixuri incluse:
 *  - NU mai existƒÉ renderSkills() (totul e randat √Æn renderStats()) ‚úÖ
 *  - Recovery handler: NU face loop infinit, NU dƒÉ localStorage.clear() ‚úÖ
 *  - Normalizare/merge de state (nu "state = s" direct) ‚úÖ
 *  - Sound saved state aplicat corect la init ‚úÖ
 *  - Migrare din key vechi v2-3 -> v2-6 (fƒÉrƒÉ sƒÉ pierzi progresul) ‚úÖ
 */

(function setupRecoveryGuards(){
  function recover(reason){
    try {
      const onceKey = "ml_pm_recovered_once";
      if (sessionStorage.getItem(onceKey) === "1") {
        console.error("MarcLab recovery already attempted. Reason:", reason);
        try {
          const t = document.getElementById("toast");
          if (t) { t.textContent = "Eroare. Deschide Dashboard ‚Üí Reset TOTAL."; t.style.display = "block"; }
        } catch {}
        return;
      }
      sessionStorage.setItem(onceKey, "1");

      // »òtergem DOAR cheile modulului (nu tot localStorage)
      localStorage.removeItem("marclab-plusminus-v2-6");
      localStorage.removeItem("marclab-plusminus-v2-3");
      localStorage.removeItem("marclab-plusminus-l1-v1");
    } catch {}
    location.reload();
  }

  window.addEventListener("error", (e) => recover(e.error || e.message));
  window.addEventListener("unhandledrejection", (e) => recover(e.reason));
})();

function safeOpenDialog(id){
  const dlg = document.getElementById(id);
  if (!dlg) return false;
  if (typeof dlg.showModal === "function") { dlg.showModal(); return true; }
  return false;
}
function safeCloseDialog(id){
  const dlg = document.getElementById(id);
  if (!dlg) return;
  if (typeof dlg.close === "function") dlg.close();
}

const SFX = (() => {
  let ctx = null;
  let enabled = true;

  function init(){
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function play(freq, type, dur, vol=0.1){
    if (!enabled) return;
    init();
    if (!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.setValueAtTime(vol, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + dur);
  }

  return {
    isEnabled: () => enabled,
    setEnabled: (v) => { enabled = !!v; return enabled; },
    toggle: () => { enabled = !enabled; return enabled; },
    correct: () => { play(523,'sine',0.1); setTimeout(()=>play(784,'sine',0.3),100); },
    wrong: () => { play(150,'sawtooth',0.3,0.2); setTimeout(()=>play(120,'sawtooth',0.3,0.2),150); },
    click: () => { play(800,'sine',0.05,0.03); }
  };
})();

const SEC = {
  salt: () => Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''),
  hash: async (pin, salt) => {
    // DacƒÉ crypto.subtle nu existƒÉ, nu putem garanta hashing sigur.
    // √én practicƒÉ, Safari/Chrome moderne au crypto.subtle.
    if (!crypto || !crypto.subtle) throw new Error("crypto.subtle unavailable");
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pin + ":" + salt));
    return Array.from(new Uint8Array(buf)).map(x=>x.toString(16).padStart(2,'0')).join('');
  }
};

const app = (() => {
  const KEY_NEW = "marclab-plusminus-v2-6";
  const KEY_OLD = "marclab-plusminus-v2-3";
  const KEY_LEGACY = "marclab-plusminus-l1-v1";
  const DEFAULT_PIN = "2580";

  function defaultState(){
    return {
      meta: { ver: 2.61, app: "PlusMinus" },
      settings: { level: 1, sound: true },
      security: { salt: "", hash: "" },
      economy: { xp: 0, coins: 0, streak: 0, level: 1 },
      skills: {
        add1: { n:"AdunƒÉri (1-10)", l:1, m:0.5 },
        sub1: { n:"ScƒÉderi (1-10)", l:1, m:0.5 },
        mk10: { n:"P√¢nƒÉ la 10", l:1, m:0.4 },
        cnt:  { n:"NumƒÉrƒÉ", l:1, m:0.5 },
        cmp1: { n:"ComparƒÉ (1-10)", l:1, m:0.5 },
        add2: { n:"AdunƒÉri (10-20)", l:1, m:0.3 },
        sub2: { n:"ScƒÉderi (10-20)", l:1, m:0.3 },
        cmp2: { n:"ComparƒÉ (10-20)", l:1, m:0.4 }
      },
      history: []
    };
  }

  // Normalize + deep-merge (anti-corruption)
  function normalizeState(input){
    const d = defaultState();
    const s = (input && typeof input === "object") ? input : {};
    const out = {
      ...d,
      ...s,
      meta: { ...d.meta, ...(s.meta||{}) },
      settings: { ...d.settings, ...(s.settings||{}) },
      security: { ...d.security, ...(s.security||{}) },
      economy: { ...d.economy, ...(s.economy||{}) },
      skills: { ...d.skills, ...(s.skills||{}) },
      history: Array.isArray(s.history) ? s.history : d.history
    };

    // basic validation
    out.settings.level = (out.settings.level === 2) ? 2 : 1;
    out.settings.sound = (out.settings.sound !== false);

    // clamp masteries
    for (const k of Object.keys(out.skills)) {
      const sk = out.skills[k];
      if (!sk || typeof sk !== "object") continue;
      if (typeof sk.m !== "number") sk.m = d.skills[k]?.m ?? 0.5;
      sk.m = Math.max(0.05, Math.min(0.99, sk.m));
      if (typeof sk.n !== "string") sk.n = d.skills[k]?.n ?? "Skill";
      if (typeof sk.l !== "number") sk.l = d.skills[k]?.l ?? 1;
    }

    return out;
  }

  let state = defaultState();
  let current = null;
  let locked = false;
  let inputBuf = "";

  const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;

  function toast(msg){
    const t = document.getElementById("toast");
    if (!t) return;
    t.textContent = msg;
    t.style.display = "block";
    setTimeout(()=>{ t.style.display = "none"; }, 2000);
  }

  function writeLegacySummary(){
    const summary = {
      meta: { brand:"MarcLab", module:"PlusMinus", version:"2.6.1", updatedAt: Date.now() },
      economy: { xp: state.economy.xp, coins: state.economy.coins, streak: state.economy.streak, level: state.economy.level },
      skills: {
        add: { name:"AdunƒÉri", level:1, mastery: state.skills.add1?.m || 0 },
        sub: { name:"ScƒÉderi", level:1, mastery: state.skills.sub1?.m || 0 },
        make10: { name:"P√¢nƒÉ la 10", level:1, mastery: state.skills.mk10?.m || 0 }
      }
    };
    localStorage.setItem(KEY_LEGACY, JSON.stringify(summary));
  }

  function save(){
    localStorage.setItem(KEY_NEW, JSON.stringify(state));
    writeLegacySummary();
  }

  function loadRaw(){
    // prefer KEY_NEW; fallback to KEY_OLD (migrƒÉm)
    const rawNew = localStorage.getItem(KEY_NEW);
    if (rawNew) return { raw: rawNew, from: KEY_NEW };
    const rawOld = localStorage.getItem(KEY_OLD);
    if (rawOld) return { raw: rawOld, from: KEY_OLD };
    return { raw: null, from: null };
  }

  async function ensurePinInit(){
    if (!state.security.salt || !state.security.hash) {
      state.security.salt = SEC.salt();
      try {
        state.security.hash = await SEC.hash(DEFAULT_PIN, state.security.salt);
      } catch (e) {
        // DacƒÉ crypto.subtle lipse»ôte, nu putem securiza hashing aici.
        // LƒÉsƒÉm pin gate ca "prompt-only" (fallback), dar √Æn practicƒÉ crypto existƒÉ.
        state.security.hash = ""; // will force fallback prompt path
      }
      save();
    }
  }

  function applySoundSetting(){
    SFX.setEnabled(state.settings.sound === true);
  }

  function getSkillSet(){
    return (state.settings.level === 1)
      ? ["add1","sub1","mk10","cnt","cmp1"]
      : ["add2","sub2","cmp2"];
  }

  function pickSkill(){
    const set = getSkillSet();
    const weights = set.map(k => {
      const sk = state.skills[k];
      const m = (sk && typeof sk.m === "number") ? sk.m : 0.5;
      return { k, w: (1 - m) + 0.2 };
    });
    const sum = weights.reduce((a,b)=>a+b.w, 0);
    let r = Math.random() * sum;
    for (const it of weights) { r -= it.w; if (r <= 0) return it.k; }
    return set[0];
  }

  function genProblem(){
    // ensure we always have a valid skill key
    let skKey = pickSkill();
    if (!state.skills[skKey]) skKey = "add1";
    const sk = state.skills[skKey];

    const p = { skill: skKey, type: "numpad", viz: null, txt: sk.n };

    if (skKey === "cnt") {
      const n = rand(3,10);
      p.ans = n; p.viz = "dots_only"; p.a = n; p.txt = "C√¢te puncte sunt?";
      return p;
    }

    if (skKey === "mk10") {
      const a = rand(1,9);
      p.a = a; p.b = 10; p.ans = 10 - a; p.op = "+"; p.viz = "tenframe"; p.mode = "missing";
      p.txt = "C√¢t lipse»ôte p√¢nƒÉ la 10?";
      return p;
    }

    if (skKey === "cmp1") {
      const a = rand(1,10), b = rand(1,10);
      p.a = a; p.b = b; p.ans = (a===b ? "=" : (a>b ? ">" : "<")); p.type = "cmp";
      p.txt = "ComparƒÉ (1‚Äì10)";
      return p;
    }

    if (skKey === "cmp2") {
      const a = rand(10,20), b = rand(10,20);
      if (a === b) return genProblem();
      p.a = a; p.b = b; p.ans = (a>b ? ">" : "<"); p.type = "cmp";
      p.txt = "ComparƒÉ (10‚Äì20)";
      return p;
    }

    if (skKey === "add1") {
      const a = rand(1,8), b = rand(1, 9-a);
      p.a = a; p.b = b; p.op = "+"; p.ans = a+b; p.viz = "dots_help";
      return p;
    }

    if (skKey === "sub1") {
      const a = rand(2,9), b = rand(1,a);
      p.a = a; p.b = b; p.op = "‚àí"; p.ans = a-b; p.viz = "dots_help";
      return p;
    }

    if (skKey === "add2") {
      const a = rand(6,9), b = rand(11-a, 9);
      p.a = a; p.b = b; p.op = "+"; p.ans = a+b;
      return p;
    }

    if (skKey === "sub2") {
      const a = rand(11,18), b = rand(a-9, 9);
      p.a = a; p.b = b; p.op = "‚àí"; p.ans = a-b;
      return p;
    }

    // fallback
    return { skill:"add1", type:"numpad", viz:"dots_help", txt:"AdunƒÉri (1-10)", a:1, b:1, op:"+", ans:2 };
  }

  function newRound(){
    locked = false;
    inputBuf = "";
    document.getElementById("uiFeedback").style.display = "none";
    current = genProblem();
    renderProblem();
  }

  function check(val){
    if (locked || val === "") return;
    locked = true;

    const correct = (current.type === "cmp")
      ? String(val) === String(current.ans)
      : Number(val) === Number(current.ans);

    const sk = state.skills[current.skill] || state.skills.add1;

    if (correct) {
      SFX.correct();
      state.economy.xp += 10;
      state.economy.streak += 1;
      sk.m = Math.min(0.99, sk.m + 0.05);
      if (state.economy.streak % 5 === 0) {
        state.economy.coins += 5;
        toast("Streak Bonus! +5 ü™ô");
      }
    } else {
      SFX.wrong();
      state.economy.streak = 0;
      sk.m = Math.max(0.05, sk.m - 0.04);
    }

    state.skills[current.skill] = sk;
    save();
    renderStats();

    const fb = document.getElementById("uiFeedback");
    fb.style.display = "flex";
    const title = document.getElementById("fbTitle");
    const btn = document.getElementById("btnNext");

    if (correct) {
      document.getElementById("fbIcon").textContent = "‚≠ê";
      title.textContent = "Corect!";
      title.style.color = "var(--good)";
      document.getElementById("fbSub").textContent = "+10 XP";
      btn.style.background = "var(--good)";
      btn.textContent = "ContinuƒÉ";
    } else {
      document.getElementById("fbIcon").textContent = "‚ùå";
      title.textContent = "Gre»ôit";
      title.style.color = "var(--bad)";
      document.getElementById("fbSub").textContent = `RƒÉspunsul era: ${current.ans}`;
      btn.style.background = "var(--warn)";
      btn.textContent = "Am √Æn»õeles";
    }
  }

  function makeEasier(){
    const sk = state.skills[current.skill];
    if (sk) {
      sk.m = Math.max(0.05, sk.m - 0.10);
      state.skills[current.skill] = sk;
      save();
      renderStats();
    }
    toast("Am simplificat pu»õin.");
    newRound();
  }

  function getDots(n){
    let s = "";
    for (let i=0;i<n;i++) s += '<div class="d-pt"></div>';
    return s;
  }
  function getFrame(n){
    let s = '<div class="ten-frame">';
    for (let i=1;i<=10;i++) s += `<div class="tf-dot ${i<=n?'filled':''}"></div>`;
    s += "</div>";
    return s;
  }

  function renderProblem(){
    const p = current;
    document.getElementById("uiSkillName").textContent = p.txt || "Exerci»õiu";
    const body = document.getElementById("uiProblem");
    let h = "";

    if (p.viz === "tenframe") {
      h += `<div class="viz-area">${getFrame(p.a)}</div>`;
    } else if (p.viz === "dots_only") {
      h += `<div class="viz-area"><div class="dot-group">${getDots(p.a)}</div></div>`;
    } else if (p.viz === "dots_help") {
      h += `<div class="viz-area">
              <div class="dot-group">${getDots(p.a)}</div>
              <div style="width:20px"></div>
              <div class="dot-group">${getDots(p.b)}</div>
            </div>`;
    }

    const box = `<div id="ansBox" class="eqBox">?</div>`;
    if (p.type === "cmp") {
      h += `<div class="big-eq"><span>${p.a}</span>${box}<span>${p.b}</span></div>`;
    } else if (p.mode === "missing") {
      h += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span>${box}<span>=</span><span>${p.b}</span></div>`;
    } else if (p.viz === "dots_only") {
      h += `<div class="big-eq">${box}</div>`;
    } else {
      h += `<div class="big-eq"><span>${p.a}</span><span>${p.op}</span><span>${p.b}</span><span>=</span>${box}</div>`;
    }

    body.innerHTML = h;
    renderKeypad();
  }

  function renderKeypad(){
    const kbd = document.getElementById("kbd");
    kbd.innerHTML = "";

    if (current.type === "cmp") {
      ["<","=",">"].forEach(s=>{
        const b = document.createElement("button");
        b.className = "btn";
        b.textContent = s;
        b.onclick = ()=>check(s);
        kbd.appendChild(b);
      });
      const skp = document.createElement("button");
      skp.className = "btn ghost";
      skp.textContent = "SchimbƒÉ";
      skp.onclick = newRound;
      skp.style.gridColumn = "span 3";
      kbd.appendChild(skp);
      return;
    }

    [1,2,3,4,5,6,7,8,9].forEach(n=>{
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = n;
      b.onclick = ()=>onInput(n);
      kbd.appendChild(b);
    });

    const del = document.createElement("button");
    del.className = "btn warn small";
    del.textContent = "‚å´";
    del.onclick = ()=>onInput("del");
    kbd.appendChild(del);

    const b0 = document.createElement("button");
    b0.className = "btn";
    b0.textContent = "0";
    b0.onclick = ()=>onInput(0);
    kbd.appendChild(b0);

    const ok = document.createElement("button");
    ok.className = "btn primary small";
    ok.textContent = "OK";
    ok.onclick = ()=>check(inputBuf);
    kbd.appendChild(ok);
  }

  function onInput(v){
    SFX.click();
    if (v === "del") inputBuf = inputBuf.slice(0,-1);
    else if (inputBuf.length < 2) inputBuf += String(v);

    const box = document.getElementById("ansBox");
    box.textContent = inputBuf || "?";
    if (inputBuf) box.classList.add("filled");
    else box.classList.remove("filled");
  }

  function renderStats(){
    document.getElementById("uiXp").textContent = state.economy.xp;
    document.getElementById("uiCoins").textContent = state.economy.coins;
    document.getElementById("uiStreak").textContent = state.economy.streak;

    document.getElementById("btnLvl1").classList.toggle("active", state.settings.level===1);
    document.getElementById("btnLvl2").classList.toggle("active", state.settings.level===2);
    document.getElementById("btnSound").style.opacity = (state.settings.sound ? 1 : 0.5);

    // Skills list (aici e "renderSkills", integrat)
    const skBox = document.getElementById("uiSkills");
    skBox.innerHTML = "";
    const list = getSkillSet();
    list.forEach(k=>{
      const sk = state.skills[k];
      if (!sk) return;
      const pct = Math.round((sk.m || 0) * 100);
      skBox.innerHTML += `
        <div class="skill-item">
          <div class="skill-top"><span>${sk.n}</span><span>${pct}%</span></div>
          <div class="meter"><div class="fill" style="width:${pct}%"></div></div>
        </div>
      `;
    });
  }

  async function init(){
    const { raw, from } = loadRaw();
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        state = normalizeState(parsed);

        // migrare: dacƒÉ venea din KEY_OLD, √Æl mutƒÉm √Æn KEY_NEW
        if (from === KEY_OLD) {
          localStorage.removeItem(KEY_OLD);
          save();
        }
      } catch (e) {
        state = defaultState();
        save();
      }
    } else {
      state = defaultState();
      save();
    }

    await ensurePinInit();
    applySoundSetting();
    renderStats();
    newRound();
  }

  // Parent gate (dialog dacƒÉ existƒÉ, altfel prompt)
  function parentGate(){
    document.getElementById("pinMsg").textContent = "";
    document.getElementById("pinInput").value = "";

    const okDialog = safeOpenDialog("pinDlg");
    if (okDialog) {
      setTimeout(()=>document.getElementById("pinInput").focus(), 100);
      return;
    }

    // fallback (dacƒÉ <dialog> nu e suportat)
    const pin = prompt("PIN pentru Dashboard:");
    if (pin == null) return;
    verifyPinAndOpen(pin.trim()).catch(()=>alert("PIN incorect."));
  }

  async function verifyPinAndOpen(pin){
    // dacƒÉ nu avem hash (crypto lipsƒÉ), fallback pe DEFAULT_PIN (slab)
    if (!state.security.hash) {
      if (pin === DEFAULT_PIN) openParent();
      else throw new Error("bad pin");
      return;
    }
    const computed = await SEC.hash(pin, state.security.salt);
    if (computed === state.security.hash) openParent();
    else throw new Error("bad pin");
  }

  function openParent(){
    document.getElementById("stateDump").value = JSON.stringify(state, null, 2);
    const okDialog = safeOpenDialog("parentDlg");
    if (!okDialog) alert("Dashboard PƒÉrinte indisponibil (browser). Folose»ôte Export JSON din alt browser.");
  }

  function resetAll(){
    if (!confirm("»òtergi tot?")) return;
    localStorage.removeItem(KEY_NEW);
    localStorage.removeItem(KEY_OLD);
    localStorage.removeItem(KEY_LEGACY);
    location.reload();
  }

  function giveCoins(){
    state.economy.coins += 50;
    save(); renderStats();
    toast("+50 ü™ô");
  }

  async function changePin(){
    const p = prompt("PIN Nou (min 4 cifre):");
    if (!p || p.trim().length < 4) return;
    state.security.salt = SEC.salt();
    try {
      state.security.hash = await SEC.hash(p.trim(), state.security.salt);
    } catch (e) {
      alert("Browserul nu suportƒÉ crypto.subtle pentru hash. PIN-ul nu poate fi securizat aici.");
      state.security.hash = "";
    }
    save();
    toast("PIN schimbat");
  }

  function exportData(){
    document.getElementById("stateDump").value = JSON.stringify(state, null, 2);
    const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "marclab_plusminus_v2_6.json";
    a.click();
  }

  function importData(el){
    const f = el.files && el.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);
        state = normalizeState(parsed);
        save();
        location.reload();
      } catch (err) {
        alert("Eroare la import (JSON invalid).");
      }
    };
    r.readAsText(f);
  }

  function setLevel(l){
    state.settings.level = (l === 2) ? 2 : 1;
    save();
    renderStats();
    newRound();
  }

  function toggleSound(){
    const newVal = SFX.toggle();
    state.settings.sound = newVal;
    save();
    renderStats();
  }

  return {
    init,
    newRound,
    check,
    makeEasier,
    setLevel,
    toggleSound,
    parentGate,
    resetAll,
    giveCoins,
    changePin,
    exportData,
    importData,
    // exposed for PIN button handler
    _verifyPinAndOpen: verifyPinAndOpen
  };
})();

document.getElementById("pinOk").onclick = async () => {
  const inp = document.getElementById("pinInput").value.trim();
  try {
    await app._verifyPinAndOpen(inp);
    safeCloseDialog("pinDlg");
  } catch {
    document.getElementById("pinMsg").textContent = "PIN incorect";
  }
};

app.init();
</script>
</body>
</html>