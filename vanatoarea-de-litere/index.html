<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Marc ‚Äî Mountain Quest</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèîÔ∏è</text></svg>">

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;900&display=swap');

    :root{
      --sky1:#7dd3fc; --sky2:#e0f2fe; --sky3:#dbeafe;
      --grass1:#34d399; --grass2:#22c55e;
      --ink:#0b1220; --white:#fff;
      --glass: rgba(0,0,0,.22);
      --stroke: rgba(255,255,255,.55);
      --shadow: 0 18px 45px rgba(0,0,0,.28);

      --good:#16a34a;
      --bad:#ef4444;
      --gold:#f59e0b;

      --modalBg: rgba(0,0,0,.78);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }

    body{
      margin:0;
      font-family: 'Quicksand', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(to bottom, var(--sky1) 0%, var(--sky2) 35%, var(--sky3) 50%, var(--grass1) 80%, var(--grass2) 100%);
      overflow:hidden;
      color: var(--ink);

      /* iOS safe area */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);

      height: 100dvh;
      min-height: 100dvh;
      touch-action: none;
      user-select:none;
    }

    /* subtle dark overlay for depth (like your Ioana game, but milder) */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 10%, rgba(255,255,255,.0), rgba(0,0,0,.10));
      pointer-events:none;
      z-index: 1;
    }

    /* Fireflies (inspiration) */
    .firefly{
      position: fixed;
      width: 4px; height: 4px;
      background-color: #ffd700;
      border-radius: 50%;
      box-shadow: 0 0 10px #ffd700, 0 0 18px rgba(255,235,59,.9);
      opacity: 0;
      z-index: 2;
      pointer-events:none;
      animation: fly 14s linear infinite;
    }
    @keyframes fly{
      0%   { transform: translate(0, 0); opacity: 0; }
      10%  { opacity: .9; }
      90%  { opacity: .9; }
      100% { transform: translate(120px, -110dvh); opacity: 0; }
    }

    /* soft glow pulse on success */
    #glow{
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 45%,
        rgba(245,158,11,.35),
        rgba(34,197,94,.18),
        rgba(0,0,0,0));
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 25;
    }

    /* Topbar */
    #topbar{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 40;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
    }

    #brand{
      font-weight: 1000;
      font-size: clamp(16px, 3.2vw, 22px);
      text-shadow: 0 2px 0 rgba(255,255,255,.85);
      white-space: nowrap;
      z-index: 40;
    }

    .hud{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
      z-index: 40;
    }

    .pill{
      background: var(--glass);
      color: var(--white);
      border: 2px solid var(--stroke);
      border-radius: 999px;
      padding: 8px 12px;
      box-shadow: 0 12px 25px rgba(0,0,0,.2);
      backdrop-filter: blur(6px);
      font-weight: 1000;
      font-size: clamp(13px, 2.6vw, 17px);
      line-height: 1;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }

    .iconbtn{
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 1000;
      font-size: clamp(13px, 2.6vw, 16px);
      background: rgba(255,255,255,.88);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .iconbtn:active{ transform: scale(.98); }

    /* Game field */
    #game{
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 3;
    }

    /* Falling items */
    .item{
      position:absolute;
      top: -110px;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.22));
      animation: fall linear forwards;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      z-index: 10;
      transform: translateZ(0);
    }
    @keyframes fall{
      to { transform: translateY(120dvh) rotate(360deg); }
    }

    .token{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 64px;
      min-height: 64px;
      padding: 10px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.80);
      border: 3px solid rgba(0,0,0,.10);
      font-weight: 1000;
      font-size: clamp(40px, 8vw, 66px);
      color: #111827;
      text-shadow: 0 3px 0 rgba(255,255,255,.9);
    }

    .emoji{ font-size: clamp(56px, 10vw, 86px); }

    .colorDot{
      width: clamp(64px, 10vw, 88px);
      height: clamp(64px, 10vw, 88px);
      border-radius: 999px;
      border: 6px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 22px rgba(0,0,0,.2);
      background: var(--c, #60a5fa);
    }

    .shapeToken{
      width: clamp(74px, 11vw, 98px);
      height: clamp(74px, 11vw, 98px);
      border-radius: 22px;
      border: 6px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 22px rgba(0,0,0,.2);
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.35);
      font-size: clamp(44px, 8.5vw, 70px);
      font-weight: 1000;
      color: #111827;
      text-shadow: 0 3px 0 rgba(255,255,255,.9);
    }

    /* Floating feedback */
    .floating{
      position:absolute;
      z-index: 50;
      font-weight: 1000;
      font-size: clamp(16px, 3.2vw, 22px);
      pointer-events:none;
      text-shadow: 0 2px 0 rgba(255,255,255,.9);
      animation: floatUp .9s ease-out forwards;
      white-space: nowrap;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) scale(1); opacity:1; }
      100%{ transform: translateY(-55px) scale(1.25); opacity:0; }
    }

    /* Modals */
    .modal{
      position: fixed;
      inset: 0;
      background: var(--modalBg);
      backdrop-filter: blur(7px);
      z-index: 120;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .card{
      width: min(860px, 94vw);
      background: rgba(255,255,255,.92);
      border-radius: 24px;
      padding: 14px;
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      border: 2px solid rgba(255,255,255,.75);
    }

    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .card h2{
      margin: 6px 0 6px;
      font-size: clamp(20px, 4vw, 30px);
    }
    .card p{
      margin: 6px 0;
      font-size: clamp(14px, 2.8vw, 18px);
      font-weight: 900;
      color: #111827;
    }

    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content:center;
      margin-top: 12px;
    }

    button{
      appearance:none;
      border:none;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 1000;
      cursor:pointer;
      font-size: clamp(14px, 3vw, 18px);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
      transform: translateZ(0);
    }
    button:active{ transform: scale(.97); }
    .primary{ background:#22c55e; color:white; }
    .secondary{ background:#111827; color:white; }
    .ghost{ background: rgba(17,24,39,.08); color:#111827; border:2px solid rgba(17,24,39,.16); }

    .tiny{
      font-size: 12px;
      color: rgba(17,24,39,.72);
      font-weight: 1000;
      margin-top: 10px;
      text-align:center;
    }

    .hidden{ display:none !important; }

    /* ===== Mountain Trail Map ===== */
    #trailWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    @media (min-width: 860px){
      #trailWrap{ grid-template-columns: 1.25fr .75fr; }
    }

    #trail{
      position: relative;
      width: 100%;
      height: min(58dvh, 420px);
      border-radius: 24px;
      overflow:hidden;
      box-shadow: 0 22px 60px rgba(0,0,0,.18);
      border: 2px solid rgba(17,24,39,.12);
      background: linear-gradient(to bottom, rgba(125,211,252,.95) 0%, rgba(224,242,254,.95) 50%, rgba(34,197,94,.92) 100%);
    }

    /* little label bubble */
    .bubble{
      background: rgba(255,255,255,.88);
      border: 2px solid rgba(17,24,39,.10);
      border-radius: 18px;
      padding: 10px 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.12);
    }

    .kv{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 1000;
      font-size: 12px;
      background: rgba(17,24,39,.06);
      border: 2px solid rgba(17,24,39,.10);
      color: rgba(17,24,39,.85);
      white-space: nowrap;
    }
    .chip.ok{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); }
    .chip.lock{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); }

    /* Flags / checkpoints */
    .cp{
      position:absolute;
      transform: translate(-50%, -50%);
      display:flex;
      flex-direction: column;
      align-items:center;
      gap: 6px;
      z-index: 10;
      cursor:pointer;
      user-select:none;
    }

    .flag{
      display:flex;
      align-items:center;
      justify-content:center;
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: rgba(255,255,255,.88);
      border: 2px solid rgba(17,24,39,.10);
      box-shadow: 0 16px 30px rgba(0,0,0,.18);
      font-size: 26px;
    }

    .flagMeta{
      font-size: 12px;
      font-weight: 1000;
      color: rgba(17,24,39,.92);
      text-shadow: 0 2px 0 rgba(255,255,255,.65);
      background: rgba(255,255,255,.65);
      border: 2px solid rgba(17,24,39,.10);
      border-radius: 999px;
      padding: 4px 8px;
    }

    .cp.locked{ cursor: not-allowed; }
    .cp.locked .flag{
      opacity: .55;
      filter: grayscale(0.4);
    }
    .cp.locked .flagMeta{
      opacity: .6;
    }

    .cp.selected .flag{
      outline: 4px solid rgba(245,158,11,.35);
      border-color: rgba(245,158,11,.55);
      transform: scale(1.04);
    }

    /* Trophy list */
    .trophyList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
      max-height: min(60dvh, 420px);
      overflow:auto;
      padding-right: 4px;
    }
    .trophyItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.85);
      border: 2px solid rgba(17,24,39,.10);
    }
    .trophyLeft{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .trophyIcon{ font-size: 28px; }
    .trophyName{ font-weight: 1000; }
    .trophyMeta{ font-weight: 900; font-size: 12px; color: rgba(17,24,39,.70); }

    /* Loading screen (inspiration) */
    #loading{
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.92);
      z-index: 300;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    .loaderCard{
      width: min(520px, 92vw);
      background: rgba(255,255,255,.10);
      border: 2px solid rgba(255,255,255,.18);
      border-radius: 22px;
      padding: 18px;
      text-align:center;
      color: rgba(255,255,255,.95);
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .spinner{
      width: 54px; height: 54px;
      border-radius: 999px;
      border: 6px solid rgba(255,255,255,.22);
      border-top-color: rgba(34,197,94,.95);
      margin: 0 auto 12px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }

    /* Pause effect */
    body.paused .item{ animation-play-state: paused !important; }
    body.paused{ cursor: default; }

    @media (prefers-reduced-motion: reduce){
      .item{ animation: none !important; }
      .floating{ animation: none !important; }
      #glow{ transition: none !important; }
      .firefly{ animation: none !important; opacity: .35; }
      .spinner{ animation: none !important; }
    }
  </style>
</head>

<body>
  <div id="glow"></div>

  <!-- Loading -->
  <div id="loading">
    <div class="loaderCard">
      <div class="spinner"></div>
      <div style="font-weight:1000; font-size:18px;">Se pregƒÉte»ôte poteca... üèîÔ∏è</div>
      <div id="loadingText" style="margin-top:10px; font-weight:900; color: rgba(255,255,255,.85);">
        Se numƒÉrƒÉ medaliile...
      </div>
    </div>
  </div>

  <div id="topbar">
    <div id="brand">üèîÔ∏è Marc ‚Äî Mountain Quest</div>
    <div class="hud">
      <div class="pill" id="hudText">Alege un nivel üèÅ</div>
      <button class="iconbtn" id="btnTrophies" title="Trofee">üèÖ</button>
      <button class="iconbtn" id="btnSound" title="Sunet">üîä OFF</button>
      <button class="iconbtn" id="btnHome" title="Harta">üó∫Ô∏è</button>
    </div>
  </div>

  <div id="game"></div>

  <!-- MAP MODAL -->
  <div id="mapModal" class="modal hidden">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 style="margin:0">Traseul pe munte üèîÔ∏èüèÅ</h2>
          <p style="margin:6px 0 0">UrcƒÉm 5 checkpoint-uri. Fiecare nivel = o medalie.</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
          <button class="ghost" id="btnReset">Reset progres</button>
          <button class="secondary" id="btnCloseMap">√énchide</button>
        </div>
      </div>

      <div id="trailWrap">
        <!-- LEFT: TRAIL -->
        <div>
          <div id="trail">
            <!-- Inline SVG mountains + path (no external assets) -->
            <svg viewBox="0 0 1000 600" width="100%" height="100%" preserveAspectRatio="none" style="position:absolute; inset:0; z-index:2;">
              <!-- distant mountains -->
              <polygon points="0,420 160,230 320,420" fill="rgba(17,24,39,.14)"/>
              <polygon points="230,440 420,200 610,440" fill="rgba(17,24,39,.12)"/>
              <polygon points="520,440 730,210 940,440" fill="rgba(17,24,39,.13)"/>
              <!-- closer hills -->
              <path d="M0,520 C200,470 320,540 520,500 C700,465 820,520 1000,485 L1000,600 L0,600 Z" fill="rgba(34,197,94,.35)"/>
              <path d="M0,540 C220,505 360,585 540,540 C720,500 860,560 1000,525 L1000,600 L0,600 Z" fill="rgba(34,197,94,.45)"/>

              <!-- trail path -->
              <path d="M90,540
                       C220,470 160,360 320,320
                       C460,285 420,200 560,180
                       C700,160 690,110 820,90
                       C900,80 940,60 930,40"
                    fill="none"
                    stroke="rgba(255,255,255,.82)"
                    stroke-width="16"
                    stroke-linecap="round"
                    stroke-dasharray="10 14"
                    opacity="0.95"/>

              <path d="M90,540
                       C220,470 160,360 320,320
                       C460,285 420,200 560,180
                       C700,160 690,110 820,90
                       C900,80 940,60 930,40"
                    fill="none"
                    stroke="rgba(17,24,39,.18)"
                    stroke-width="6"
                    stroke-linecap="round"
                    opacity="0.75"/>
            </svg>

            <!-- checkpoints injected by JS -->
            <div id="checkpoints" style="position:absolute; inset:0; z-index:12;"></div>
          </div>

          <div class="tiny">
            Hint: apasƒÉ pe stegule»õ ca sƒÉ alegi nivelul. üèÅ
          </div>
        </div>

        <!-- RIGHT: DETAILS -->
        <div class="bubble">
          <div style="font-weight:1000; font-size:18px;" id="selTitle">SelecteazƒÉ un checkpoint üèÅ</div>
          <div style="margin-top:8px; font-weight:900; color: rgba(17,24,39,.78);" id="selDesc">Aici apar detaliile nivelului.</div>

          <div class="kv" id="selChips" style="margin-top:10px;"></div>

          <div class="actions" style="justify-content:flex-start;">
            <button class="primary" id="btnStartLevel" disabled>Start nivel</button>
            <button class="ghost" id="btnOpenTrophiesFromMap">Vezi trofee</button>
          </div>

          <div class="tiny" style="text-align:left;">
            Auto-save: progresul se salveazƒÉ pe device (LocalStorage).
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- END MODAL -->
  <div id="endModal" class="modal hidden">
    <div class="card" style="text-align:center;">
      <h2 id="endTitle" style="margin:6px 0 8px;">BRAVO! üèÖ</h2>
      <p id="endMsg" style="margin:0 0 6px;">Ai terminat nivelul!</p>
      <p id="endStats" style="margin:0 0 10px; color: rgba(17,24,39,.8);"></p>

      <div class="actions">
        <button class="primary" id="btnNext">UrmƒÉtorul checkpoint ‚û°Ô∏è</button>
        <button class="ghost" id="btnReplay">RepetƒÉ nivelul üîÅ</button>
        <button class="secondary" id="btnBackToMap">Harta üó∫Ô∏è</button>
      </div>

      <div class="tiny">Next-next: putem adƒÉuga ‚Äústicker book‚Äù cu trofee animate üß∑</div>
    </div>
  </div>

  <!-- TROPHIES -->
  <div id="trophyModal" class="modal hidden">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 style="margin:0">Album Trofee üèÖ</h2>
          <p style="margin:6px 0 0">Se salveazƒÉ automat pe device (LocalStorage).</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap: wrap;">
          <button class="ghost" id="btnReset2">Reset progres</button>
          <button class="secondary" id="btnCloseTrophies">√énchide</button>
        </div>
      </div>

      <div class="trophyList" id="trophyList"></div>

      <div class="tiny">
        Tip: dacƒÉ deschizi trofeele √Æn timpul jocului, jocul se pune pe pauzƒÉ üßä
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = 'marc_mountain_quest_v2';

  const game = document.getElementById('game');
  const glow = document.getElementById('glow');
  const hudText = document.getElementById('hudText');

  const btnTrophies = document.getElementById('btnTrophies');
  const btnSound = document.getElementById('btnSound');
  const btnHome = document.getElementById('btnHome');

  const loading = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');

  const mapModal = document.getElementById('mapModal');
  const btnReset = document.getElementById('btnReset');
  const btnReset2 = document.getElementById('btnReset2');
  const btnCloseMap = document.getElementById('btnCloseMap');

  const checkpointsEl = document.getElementById('checkpoints');

  const selTitle = document.getElementById('selTitle');
  const selDesc = document.getElementById('selDesc');
  const selChips = document.getElementById('selChips');
  const btnStartLevel = document.getElementById('btnStartLevel');
  const btnOpenTrophiesFromMap = document.getElementById('btnOpenTrophiesFromMap');

  const endModal = document.getElementById('endModal');
  const endTitle = document.getElementById('endTitle');
  const endMsg = document.getElementById('endMsg');
  const endStats = document.getElementById('endStats');
  const btnNext = document.getElementById('btnNext');
  const btnReplay = document.getElementById('btnReplay');
  const btnBackToMap = document.getElementById('btnBackToMap');

  const trophyModal = document.getElementById('trophyModal');
  const trophyList = document.getElementById('trophyList');
  const btnCloseTrophies = document.getElementById('btnCloseTrophies');

  // ========= Audio (optional) =========
  let soundOn = false;
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) audioCtx = new AC();
    }
  }
  function beep(freq=660, ms=70){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = freq;
    o.type = 'sine';
    g.gain.value = 0.04;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, ms);
  }

  // ========= Helpers =========
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const nowISO = () => new Date().toISOString();
  const fmtDate = (iso) => {
    if (!iso) return '‚Äî';
    const d = new Date(iso);
    return d.toLocaleString('ro-RO', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
  };

  function setHud(text){ hudText.textContent = text; }
  function glowPulse(){
    glow.style.opacity = '1';
    setTimeout(()=> glow.style.opacity = '0', 180);
  }
  function confettiBurst(){
    confetti({ particleCount: 70, spread: 70, startVelocity: 35, origin: { y: 0.65 }, disableForReducedMotion: true });
  }
  function confettiParty(ms=1600){
    const t0 = Date.now();
    const iv = setInterval(() => {
      confetti({
        particleCount: 40,
        spread: 90,
        startVelocity: 28,
        origin: { x: Math.random(), y: Math.random()*0.4 + 0.2 },
        disableForReducedMotion: true
      });
      if (Date.now() - t0 > ms) clearInterval(iv);
    }, 220);
  }

  // Sparkles at click location (inspiration from your explode())
  function sparkle(x, y, kind){
    let colors = ['#ffffff'];
    if (kind === 'target') colors = ['#22c55e', '#a7f3d0'];
    if (kind === 'fun')    colors = ['#60a5fa', '#f59e0b'];
    if (kind === 'bad')    colors = ['#ef4444', '#b91c1c'];

    confetti({
      particleCount: 14,
      spread: 40,
      origin: { x: x / window.innerWidth, y: y / window.innerHeight },
      colors,
      disableForReducedMotion: true,
      gravity: 2,
      scalar: 0.85,
      zIndex: 99
    });
  }

  function showFloating(x, y, text, color){
    const el = document.createElement('div');
    el.className = 'floating';
    el.textContent = text;
    el.style.color = color;

    const pad = 10;
    const vw = window.innerWidth, vh = window.innerHeight;
    const left = clamp(x - 40, pad, vw - 140);
    const top  = clamp(y - 60, pad + 60, vh - 140);
    el.style.left = left + 'px';
    el.style.top = top + 'px';

    game.appendChild(el);
    setTimeout(()=> el.remove(), 900);
  }

  function cleanupField(){
    game.querySelectorAll('.item, .floating').forEach(el => el.remove());
  }

  // ========= Levels =========
  const LEVELS = [
    {
      id: 'letters',
      title: 'MARC',
      icon: 'üß©',
      medal: 'ü•â',
      desc: 'Prinde literele M A R C (orice ordine).',
      mode: 'set',
      targets: ['M','A','R','C'],
      renderer: (val) => {
        const d = document.createElement('div');
        d.className = 'token';
        d.textContent = val;
        return d;
      },
      spawn: { target: 0.62, bad: 0.14, fun: 0.24 }
    },
    {
      id: 'numbers',
      title: '1‚Äì10',
      icon: 'üî¢',
      medal: 'ü•à',
      desc: 'Prinde numerele 1‚Üí10 √Æn ordine.',
      mode: 'sequence',
      targets: ['1','2','3','4','5','6','7','8','9','10'],
      renderer: (val) => {
        const d = document.createElement('div');
        d.className = 'token';
        d.textContent = val;
        return d;
      },
      spawn: { target: 0.68, bad: 0.12, fun: 0.20 }
    },
    {
      id: 'colors',
      title: 'Culori',
      icon: 'üé®',
      medal: 'ü•á',
      desc: 'Prinde: ro»ôu, galben, verde, albastru, mov.',
      mode: 'set',
      targets: ['red','yellow','green','blue','purple'],
      labels: { red:'Ro»ôu', yellow:'Galben', green:'Verde', blue:'Albastru', purple:'Mov' },
      renderer: (val) => {
        const d = document.createElement('div');
        d.className = 'colorDot';
        d.style.setProperty('--c', colorHex(val));
        return d;
      },
      spawn: { target: 0.64, bad: 0.12, fun: 0.24 }
    },
    {
      id: 'shapes',
      title: 'Forme',
      icon: 'üî∫',
      medal: 'üèÖ',
      desc: 'Prinde: cerc, pƒÉtrat, triunghi, diamant, stea.',
      mode: 'set',
      targets: ['circle','square','triangle','diamond','star'],
      labels: { circle:'Cerc', square:'PƒÉtrat', triangle:'Triunghi', diamond:'Diamant', star:'Stea' },
      renderer: (val) => {
        const d = document.createElement('div');
        d.className = 'shapeToken';
        d.textContent = shapeChar(val);
        return d;
      },
      spawn: { target: 0.62, bad: 0.14, fun: 0.24 }
    },
    {
      id: 'animals',
      title: 'Animale',
      icon: 'ü¶ä',
      medal: 'üèÜ',
      desc: 'Prinde: c√¢ine, pisicƒÉ, iepure, urs, vulpe.',
      mode: 'set',
      targets: ['dog','cat','rabbit','bear','fox'],
      labels: { dog:'C√¢ine', cat:'PisicƒÉ', rabbit:'Iepure', bear:'Urs', fox:'Vulpe' },
      renderer: (val) => {
        const d = document.createElement('div');
        d.className = 'emoji';
        d.textContent = animalEmoji(val);
        return d;
      },
      spawn: { target: 0.60, bad: 0.14, fun: 0.26 }
    }
  ];

  const FUN_EMOJIS = ['ü¶ñ','üöÄ','‚≠ê','üåà','üçÑ','üçì','üßÉ','‚ö°','üß†'];
  const BAD_EMOJIS = ['üåßÔ∏è','‚òÅÔ∏è','‚õàÔ∏è'];
  const PRAISE = ["Super! ‚ú®","Bravo! üèÖ","High-five! üñêÔ∏è","E»ôti tare! üí™","Perfect! üòÑ","Bun! üî•"];

  function shapeChar(v){
    switch(v){
      case 'circle': return '‚óè';
      case 'square': return '‚ñ†';
      case 'triangle': return '‚ñ≤';
      case 'diamond': return '‚óÜ';
      case 'star': return '‚òÖ';
      default: return '‚ú¶';
    }
  }
  function animalEmoji(v){
    switch(v){
      case 'dog': return 'üê∂';
      case 'cat': return 'üê±';
      case 'rabbit': return 'üê∞';
      case 'bear': return 'üêª';
      case 'fox': return 'ü¶ä';
      default: return 'üêæ';
    }
  }
  function colorHex(v){
    switch(v){
      case 'red': return '#ef4444';
      case 'yellow': return '#f59e0b';
      case 'green': return '#22c55e';
      case 'blue': return '#3b82f6';
      case 'purple': return '#a855f7';
      default: return '#60a5fa';
    }
  }

  // ========= State (LocalStorage) =========
  const defaultState = () => ({
    settings: { soundOn: false },
    progress: {
      levels: Object.fromEntries(LEVELS.map(l => [l.id, {
        completed: false,
        bestTime: null,
        lastTime: null,
        tries: 0,
        lastPlayed: null
      }]))
    }
  });

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      const base = defaultState();
      return {
        settings: { ...base.settings, ...(parsed.settings || {}) },
        progress: { levels: { ...base.progress.levels, ...((parsed.progress && parsed.progress.levels) || {}) } }
      };
    }catch(e){
      return defaultState();
    }
  }
  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
  }
  function resetProgress(){
    state = defaultState();
    soundOn = !!state.settings.soundOn;
    syncSoundButton();
    saveState();
    renderMap();
    renderTrophies();
  }

  function isUnlocked(levelId){
    const idx = LEVELS.findIndex(l => l.id === levelId);
    if (idx === 0) return true;
    const prev = LEVELS[idx - 1].id;
    return !!state.progress.levels[prev]?.completed;
  }

  // ========= Mountain checkpoints coordinates (percent) =========
  const CP_POS = [
    { x: 9,  y: 90 },  // bottom-left
    { x: 32, y: 63 },
    { x: 56, y: 43 },
    { x: 82, y: 22 },
    { x: 93, y: 9 }    // top-right summit
  ];

  let selectedLevelId = LEVELS[0].id;

  function selectLevel(levelId){
    selectedLevelId = levelId;
    const lvl = LEVELS.find(l => l.id === levelId);
    const prog = state.progress.levels[levelId];
    const unlocked = isUnlocked(levelId);

    // Update selected styles
    checkpointsEl.querySelectorAll('.cp').forEach(el => {
      el.classList.toggle('selected', el.dataset.level === levelId);
    });

    selTitle.textContent = `${lvl.icon} ${lvl.title} ${prog.completed ? lvl.medal : ''}`.trim();
    selDesc.textContent = lvl.desc;

    selChips.innerHTML = '';
    const chipStatus = document.createElement('div');
    chipStatus.className = 'chip ' + (prog.completed ? 'ok' : (unlocked ? '' : 'lock'));
    chipStatus.textContent = prog.completed ? `Medalie: ${lvl.medal}` : (unlocked ? 'Disponibil' : 'Blocat');
    selChips.appendChild(chipStatus);

    const chipBest = document.createElement('div');
    chipBest.className = 'chip';
    chipBest.textContent = `Best: ${prog.bestTime ? prog.bestTime+'s' : '‚Äî'}`;
    selChips.appendChild(chipBest);

    const chipTries = document.createElement('div');
    chipTries.className = 'chip';
    chipTries.textContent = `√éncercƒÉri: ${prog.tries || 0}`;
    selChips.appendChild(chipTries);

    const chipLast = document.createElement('div');
    chipLast.className = 'chip';
    chipLast.textContent = `Ultima: ${fmtDate(prog.lastPlayed)}`;
    selChips.appendChild(chipLast);

    btnStartLevel.disabled = !unlocked;
    btnStartLevel.textContent = unlocked ? (prog.completed ? 'JoacƒÉ din nou' : 'Start nivel') : 'Blocat';
  }

  function renderMap(){
    checkpointsEl.innerHTML = '';

    LEVELS.forEach((lvl, idx) => {
      const prog = state.progress.levels[lvl.id];
      const unlocked = isUnlocked(lvl.id);

      const cp = document.createElement('div');
      cp.className = 'cp' + (unlocked ? '' : ' locked');
      cp.dataset.level = lvl.id;
      cp.style.left = CP_POS[idx].x + '%';
      cp.style.top  = CP_POS[idx].y + '%';

      const flag = document.createElement('div');
      flag.className = 'flag';
      flag.textContent = prog.completed ? lvl.medal : 'üèÅ';

      const meta = document.createElement('div');
      meta.className = 'flagMeta';
      meta.textContent = `${idx+1}. ${lvl.title}`;

      cp.appendChild(flag);
      cp.appendChild(meta);

      cp.addEventListener('click', () => {
        if(!unlocked){
          beep(220, 90);
          selectLevel(lvl.id);
          // gentle "locked" hint
          selDesc.textContent = 'Acest checkpoint e blocat. TerminƒÉ nivelul anterior ca sƒÉ urcƒÉm mai sus üßó';
          return;
        }
        beep(720, 55);
        selectLevel(lvl.id);
      });

      checkpointsEl.appendChild(cp);
    });

    // default selection: highest unlocked not completed OR highest unlocked
    const highestUnlockedIdx = [...LEVELS].map((l,i)=>({l,i}))
      .filter(x => isUnlocked(x.l.id))
      .map(x=>x.i)
      .pop() ?? 0;

    const candidate = LEVELS.find((l,i)=> isUnlocked(l.id) && !state.progress.levels[l.id].completed) || LEVELS[highestUnlockedIdx];
    selectLevel(candidate.id);

    openMap(true);
    setHud('Alege un nivel üèÅ');
  }

  function openMap(open){
    mapModal.classList.toggle('hidden', !open);
    setPaused(open); // pause gameplay if map open
  }

  // ========= Trophies =========
  function renderTrophies(){
    trophyList.innerHTML = '';
    LEVELS.forEach((lvl, idx) => {
      const prog = state.progress.levels[lvl.id];

      const row = document.createElement('div');
      row.className = 'trophyItem';

      const left = document.createElement('div');
      left.className = 'trophyLeft';

      const icon = document.createElement('div');
      icon.className = 'trophyIcon';
      icon.textContent = prog.completed ? lvl.medal : '‚¨ú';

      const text = document.createElement('div');
      const name = document.createElement('div');
      name.className = 'trophyName';
      name.textContent = `${idx+1}. ${lvl.icon} ${lvl.title}`;

      const meta = document.createElement('div');
      meta.className = 'trophyMeta';
      meta.textContent = `Best: ${prog.bestTime ? prog.bestTime+'s' : '‚Äî'} ‚Ä¢ √éncercƒÉri: ${prog.tries || 0} ‚Ä¢ Ultima: ${fmtDate(prog.lastPlayed)}`;

      text.appendChild(name);
      text.appendChild(meta);

      left.appendChild(icon);
      left.appendChild(text);

      const right = document.createElement('div');
      right.style.fontWeight = '1000';
      right.style.fontSize = '13px';
      right.style.color = prog.completed ? 'rgba(34,197,94,.9)' : 'rgba(17,24,39,.55)';
      right.textContent = prog.completed ? 'C√¢»ôtigat ‚úÖ' : '√éncƒÉ nu';

      row.appendChild(left);
      row.appendChild(right);

      trophyList.appendChild(row);
    });
  }

  function openTrophies(open){
    trophyModal.classList.toggle('hidden', !open);
    if(open) renderTrophies();
    setPaused(open); // pause gameplay if trophies open
  }

  // ========= Gameplay core =========
  let active = false;
  let paused = false;
  let spawnTimer = null;
  let startTime = 0;
  let currentLevel = null;

  let collectedSet = new Set();
  let seqIndex = 0;

  // Base tuning (kid-friendly), but we make it slightly faster as progress grows
  const BASE_SPAWN_MS = 950;
  const FALL_MIN = 4.0;
  const FALL_MAX = 6.2;
  const MAX_ONSCREEN = 12;

  function setPaused(p){
    paused = !!p;
    document.body.classList.toggle('paused', paused);

    // stop/resume spawning loop gracefully
    if(paused){
      // keep timer but spawnLoop checks paused; also freeze CSS via body.paused
    } else {
      // nothing special; loop resumes
    }
  }

  function updateHud(){
    if(!currentLevel){
      setHud('Alege un nivel üèÅ');
      return;
    }
    const lvl = currentLevel;
    if(lvl.mode === 'sequence'){
      const next = lvl.targets[seqIndex] || '‚Äî';
      setHud(`${lvl.icon} ${lvl.title} ‚Ä¢ UrmƒÉtorul: ${next} ‚Ä¢ ${seqIndex}/${lvl.targets.length}`);
    } else {
      setHud(`${lvl.icon} ${lvl.title} ‚Ä¢ ${collectedSet.size}/${lvl.targets.length}`);
    }
  }

  function progressRatio(){
    if(!currentLevel) return 0;
    if(currentLevel.mode === 'sequence'){
      return currentLevel.targets.length ? (seqIndex / currentLevel.targets.length) : 0;
    }
    return currentLevel.targets.length ? (collectedSet.size / currentLevel.targets.length) : 0;
  }

  function currentSpawnDelay(){
    // speed up slightly as progress increases (like your progressive difficulty, but gentle)
    const r = progressRatio(); // 0..1
    const d = BASE_SPAWN_MS - Math.round(220 * r); // up to -220ms
    return clamp(d, 650, 1050);
  }

  function startLevel(levelId){
    const lvl = LEVELS.find(l => l.id === levelId);
    if(!lvl) return;
    if(!isUnlocked(levelId)) return;

    // tries + last played
    state.progress.levels[levelId].tries = (state.progress.levels[levelId].tries || 0) + 1;
    state.progress.levels[levelId].lastPlayed = nowISO();
    saveState();

    // reset state
    currentLevel = lvl;
    collectedSet = new Set();
    seqIndex = 0;

    cleanupField();
    openMap(false);
    openTrophies(false);
    endModal.classList.add('hidden');

    active = true;
    paused = false;
    document.body.classList.remove('paused');

    startTime = Date.now();
    updateHud();

    if(spawnTimer) clearTimeout(spawnTimer);
    spawnLoop(); // dynamic timer
  }

  function spawnLoop(){
    if(!active) return;

    if(paused){
      spawnTimer = setTimeout(spawnLoop, 120);
      return;
    }

    spawnItem();
    spawnTimer = setTimeout(spawnLoop, currentSpawnDelay());
  }

  function endLevel(completed){
    active = false;
    if(spawnTimer) clearTimeout(spawnTimer);
    cleanupField();

    if(!currentLevel) return;

    const elapsed = Math.max(1, Math.round((Date.now() - startTime) / 1000));
    const prog = state.progress.levels[currentLevel.id];

    prog.lastTime = elapsed;
    if(completed){
      prog.completed = true;
      prog.bestTime = prog.bestTime ? Math.min(prog.bestTime, elapsed) : elapsed;
    }
    saveState();

    if(completed){
      glowPulse();
      confettiBurst();
      confettiParty(1600);
      beep(880, 70);

      endTitle.textContent = `BRAVO! ${currentLevel.medal}`;
      endMsg.textContent = `Ai c√¢»ôtigat medalia la ${currentLevel.icon} ${currentLevel.title}!`;
      const best = prog.bestTime ? prog.bestTime + 's' : '‚Äî';
      endStats.textContent = `Timp: ${elapsed}s ‚Ä¢ Best: ${best} ‚Ä¢ √éncercƒÉri: ${prog.tries || 0}`;

      const idx = LEVELS.findIndex(l => l.id === currentLevel.id);
      const hasNext = idx < LEVELS.length - 1;
      btnNext.disabled = !hasNext;
      btnNext.style.opacity = hasNext ? '1' : '.55';

      endModal.classList.remove('hidden');
      setPaused(true);
    } else {
      renderMap();
    }
  }

  function completeIfReady(){
    if(!currentLevel) return;
    if(currentLevel.mode === 'sequence'){
      if(seqIndex >= currentLevel.targets.length) endLevel(true);
    } else {
      if(collectedSet.size >= currentLevel.targets.length) endLevel(true);
    }
  }

  function randomFallDuration(isTarget){
    const min = isTarget ? FALL_MIN : (FALL_MIN - 0.2);
    const max = isTarget ? FALL_MAX : (FALL_MAX - 0.1);
    return (Math.random() * (max - min) + min).toFixed(2);
  }

  function spawnItem(){
    if(!active || paused || !currentLevel) return;
    if(game.querySelectorAll('.item').length >= MAX_ONSCREEN) return;

    const lvl = currentLevel;

    // decide kind
    const r = Math.random();
    let kind = 'fun';
    if (r < lvl.spawn.target) kind = 'target';
    else if (r < lvl.spawn.target + lvl.spawn.bad) kind = 'bad';
    else kind = 'fun';

    const wrap = document.createElement('div');
    wrap.className = 'item';

    let payload = null;
    let isTarget = (kind === 'target');

    if(kind === 'bad'){
      payload = BAD_EMOJIS[Math.floor(Math.random() * BAD_EMOJIS.length)];
      const el = document.createElement('div');
      el.className = 'emoji';
      el.textContent = payload;
      wrap.dataset.kind = 'bad';
      wrap.appendChild(el);
    } else if(kind === 'fun'){
      payload = FUN_EMOJIS[Math.floor(Math.random() * FUN_EMOJIS.length)];
      const el = document.createElement('div');
      el.className = 'emoji';
      el.textContent = payload;
      wrap.dataset.kind = 'fun';
      wrap.appendChild(el);
    } else {
      // target
      if(lvl.mode === 'sequence'){
        const next = lvl.targets[seqIndex] || lvl.targets[lvl.targets.length - 1];
        const roll = Math.random();
        payload = roll < 0.72 ? next : lvl.targets[Math.floor(Math.random() * lvl.targets.length)];
      } else {
        const missing = lvl.targets.filter(t => !collectedSet.has(t));
        payload = (missing.length && Math.random() < 0.75)
          ? missing[Math.floor(Math.random() * missing.length)]
          : lvl.targets[Math.floor(Math.random() * lvl.targets.length)];
      }

      wrap.dataset.kind = 'target';
      wrap.dataset.val = payload;

      const rendered = lvl.renderer(payload, lvl);
      wrap.appendChild(rendered);
    }

    // position
    const leftPct = Math.random() * 78 + 11; // 11..89
    wrap.style.left = leftPct + '%';

    // duration (targets a bit slower)
    const dur = randomFallDuration(isTarget);
    wrap.style.animationDuration = dur + 's';

    wrap.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(!active || paused) return;

      const x = e.clientX;
      const y = e.clientY;
      catchItem(wrap, x, y);
    });

    game.appendChild(wrap);

    setTimeout(() => {
      if (wrap.parentNode) wrap.remove();
    }, Number(dur) * 1000);
  }

  function catchItem(wrap, x, y){
    if(!active || paused || !currentLevel) return;

    // stop animation to avoid "jump"
    wrap.style.animation = 'none';

    const kind = wrap.dataset.kind;
    sparkle(x, y, kind);

    if(kind === 'bad'){
      beep(220, 90);
      showFloating(x, y, "Ups! ‚òî", 'var(--bad)');
      if (navigator.vibrate) navigator.vibrate(120);
    } else if(kind === 'fun'){
      beep(720, 55);
      const msg = PRAISE[Math.floor(Math.random() * PRAISE.length)];
      showFloating(x, y, msg, '#0b1220');
    } else {
      // target
      const val = wrap.dataset.val;
      const lvl = currentLevel;

      if(lvl.mode === 'sequence'){
        const next = lvl.targets[seqIndex];
        if(val === next){
          seqIndex++;
          glowPulse();
          confettiBurst();
          beep(880, 70);
          showFloating(x, y, `Corect! ‚úÖ`, 'var(--good)');
          updateHud();
          completeIfReady();
        } else {
          beep(420, 70);
          showFloating(x, y, `Nu √ÆncƒÉ üòÑ`, 'rgba(17,24,39,.75)');
        }
      } else {
        if(!collectedSet.has(val)){
          collectedSet.add(val);
          glowPulse();
          confettiBurst();
          beep(880, 70);

          let nice = val;
          if(lvl.labels && lvl.labels[val]) nice = lvl.labels[val];
          showFloating(x, y, `+ ${nice} ‚úÖ`, 'var(--good)');

          updateHud();
          completeIfReady();
        } else {
          beep(600, 55);
          showFloating(x, y, "Avem deja üòÑ", 'rgba(17,24,39,.75)');
        }
      }

      if (navigator.vibrate) navigator.vibrate([60, 30, 60]);
    }

    // pop away
    wrap.style.transition = 'transform 120ms ease, opacity 120ms ease';
    wrap.style.transform = 'scale(1.35)';
    wrap.style.opacity = '0';
    setTimeout(()=> { if(wrap.parentNode) wrap.remove(); }, 130);
  }

  // ========= Buttons =========
  function syncSoundButton(){
    btnSound.textContent = soundOn ? 'üîä ON' : 'üîä OFF';
  }

  btnSound.addEventListener('click', () => {
    soundOn = !soundOn;
    state.settings.soundOn = soundOn;
    syncSoundButton();
    if (soundOn) ensureAudio();
    saveState();
  });

  btnHome.addEventListener('click', () => {
    // stop gameplay and go map
    active = false;
    if(spawnTimer) clearTimeout(spawnTimer);
    cleanupField();
    currentLevel = null;
    setPaused(false);
    renderMap();
  });

  btnTrophies.addEventListener('click', () => openTrophies(true));

  btnCloseMap.addEventListener('click', () => openMap(false));

  btnReset.addEventListener('click', () => {
    if(confirm('Sigur resetezi tot progresul »ôi trofeele?')) resetProgress();
  });
  btnReset2.addEventListener('click', () => {
    if(confirm('Sigur resetezi tot progresul »ôi trofeele?')) {
      resetProgress();
      openTrophies(true);
    }
  });

  btnCloseTrophies.addEventListener('click', () => openTrophies(false));

  btnOpenTrophiesFromMap.addEventListener('click', () => openTrophies(true));

  btnStartLevel.addEventListener('click', () => startLevel(selectedLevelId));

  btnBackToMap.addEventListener('click', () => {
    endModal.classList.add('hidden');
    setPaused(false);
    renderMap();
  });

  btnReplay.addEventListener('click', () => {
    endModal.classList.add('hidden');
    setPaused(false);
    if(currentLevel) startLevel(currentLevel.id);
  });

  btnNext.addEventListener('click', () => {
    if(!currentLevel) return;
    const idx = LEVELS.findIndex(l => l.id === currentLevel.id);
    const next = LEVELS[idx + 1];
    endModal.classList.add('hidden');
    setPaused(false);
    if(next) startLevel(next.id);
  });

  // ========= Visibility pause =========
  document.addEventListener('visibilitychange', () => {
    if(!active) return;
    if(document.hidden){
      setPaused(true);
    } else {
      // resume only if no modal open
      const modalOpen = !mapModal.classList.contains('hidden') || !trophyModal.classList.contains('hidden') || !endModal.classList.contains('hidden');
      setPaused(modalOpen);
    }
  });

  // ========= Fireflies =========
  function createFireflies(n=14){
    for(let i=0; i<n; i++){
      const fly = document.createElement('div');
      fly.className = 'firefly';
      fly.style.left = Math.random() * 100 + '%';
      fly.style.top  = (Math.random() * 80 + 10) + '%';
      fly.style.animationDuration = (Math.random() * 9 + 10) + 's';
      fly.style.animationDelay = (Math.random() * 5) + 's';
      document.body.appendChild(fly);
    }
  }

  // ========= Loading screen =========
  function runLoading(){
    const texts = [
      "Se numƒÉrƒÉ medaliile...",
      "Se a»ôazƒÉ stegule»õele...",
      "Se aprind licuricii...",
      "Gata de urcare! üßó"
    ];
    let i = 0;
    loadingText.textContent = texts[0];

    const iv = setInterval(() => {
      i++;
      if(i < texts.length){
        loadingText.textContent = texts[i];
      } else {
        clearInterval(iv);
        loading.classList.add('hidden');
        renderMap();
      }
    }, 650);
  }

  // ========= Init =========
  function init(){
    soundOn = !!state.settings.soundOn;
    syncSoundButton();
    createFireflies(14);
    renderTrophies();
    runLoading();
  }

  init();
})();
</script>

</body>
</html>