<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Marc ‚Äî Level Quest</title>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700;900&display=swap');

    :root{
      --bg1:#7dd3fc; --bg2:#e0f2fe; --bg3:#22c55e;
      --ink:#0b1220; --white:#fff;
      --glass: rgba(0,0,0,.22);
      --stroke: rgba(255,255,255,.55);
      --shadow: 0 18px 45px rgba(0,0,0,.28);
      --good:#16a34a; --bad:#ef4444; --gold:#f59e0b; --muted: rgba(17,24,39,.7);
    }

    *{ box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: 'Quicksand', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(to bottom, var(--bg1) 0%, var(--bg2) 45%, var(--bg3) 100%);
      overflow:hidden;

      /* iOS safe area */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);

      height: 100dvh;
      min-height: 100dvh;
      touch-action: none;
      user-select:none;
      color: var(--ink);
    }

    /* soft glow on success */
    #glow{
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 50% 45%,
        rgba(245,158,11,.35),
        rgba(34,197,94,.18),
        rgba(0,0,0,0));
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 25;
    }

    /* topbar */
    #topbar{
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 40;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
    }

    #brand{
      font-weight: 900;
      font-size: clamp(16px, 3.2vw, 22px);
      text-shadow: 0 2px 0 rgba(255,255,255,.85);
      white-space: nowrap;
    }

    .hud{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .pill{
      background: var(--glass);
      color: var(--white);
      border: 2px solid var(--stroke);
      border-radius: 999px;
      padding: 8px 12px;
      box-shadow: 0 12px 25px rgba(0,0,0,.2);
      backdrop-filter: blur(6px);
      font-weight: 900;
      font-size: clamp(13px, 2.6vw, 17px);
      line-height: 1;
      display:flex;
      align-items:center;
      gap: 8px;
      white-space: nowrap;
    }

    .iconbtn{
      border:none;
      cursor:pointer;
      border-radius: 999px;
      padding: 8px 10px;
      font-weight: 900;
      font-size: clamp(13px, 2.6vw, 16px);
      background: rgba(255,255,255,.85);
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .iconbtn:active{ transform: scale(.98); }

    #game{
      position: relative;
      width: 100%;
      height: 100%;
    }

    /* falling items */
    .item{
      position:absolute;
      top: -100px;
      filter: drop-shadow(0 14px 20px rgba(0,0,0,.22));
      animation: fall linear forwards;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
      z-index: 10;
    }

    @keyframes fall{
      to { transform: translateY(120dvh) rotate(360deg); }
    }

    /* token styles */
    .token{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 64px;
      min-height: 64px;
      padding: 10px 16px;
      border-radius: 18px;
      background: rgba(255,255,255,.78);
      border: 3px solid rgba(0,0,0,.10);
      font-weight: 1000;
      font-size: clamp(40px, 8vw, 66px);
      color: #111827;
      text-shadow: 0 3px 0 rgba(255,255,255,.9);
    }

    .emoji{
      font-size: clamp(56px, 10vw, 86px);
    }

    .colorDot{
      width: clamp(64px, 10vw, 88px);
      height: clamp(64px, 10vw, 88px);
      border-radius: 999px;
      border: 6px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 22px rgba(0,0,0,.2);
      background: var(--c, #60a5fa);
    }

    .shapeToken{
      width: clamp(74px, 11vw, 98px);
      height: clamp(74px, 11vw, 98px);
      border-radius: 22px;
      border: 6px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 22px rgba(0,0,0,.2);
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,.35);
      font-size: clamp(44px, 8.5vw, 70px);
      font-weight: 1000;
      color: #111827;
      text-shadow: 0 3px 0 rgba(255,255,255,.9);
    }

    /* floating feedback */
    .floating{
      position:absolute;
      z-index: 50;
      font-weight: 1000;
      font-size: clamp(16px, 3.2vw, 22px);
      pointer-events:none;
      text-shadow: 0 2px 0 rgba(255,255,255,.9);
      animation: floatUp .9s ease-out forwards;
      white-space: nowrap;
    }

    @keyframes floatUp{
      0%{ transform: translateY(0) scale(1); opacity:1; }
      100%{ transform: translateY(-55px) scale(1.25); opacity:0; }
    }

    /* modals */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.78);
      backdrop-filter: blur(7px);
      z-index: 100;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 20px;
    }

    .card{
      width: min(720px, 94vw);
      background: rgba(255,255,255,.92);
      border-radius: 24px;
      padding: 16px;
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      border: 2px solid rgba(255,255,255,.75);
    }

    .cardHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .card h2{
      margin: 6px 0 6px;
      font-size: clamp(22px, 4vw, 30px);
    }
    .card p{
      margin: 6px 0;
      font-size: clamp(14px, 2.8vw, 18px);
      font-weight: 800;
      color: #111827;
    }

    .actions{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content:center;
      margin-top: 12px;
    }

    button{
      appearance:none;
      border:none;
      padding: 14px 18px;
      border-radius: 999px;
      font-weight: 1000;
      cursor:pointer;
      font-size: clamp(15px, 3vw, 18px);
      box-shadow: 0 14px 30px rgba(0,0,0,.25);
      transform: translateZ(0);
    }
    button:active{ transform: scale(.97); }
    .primary{ background:#22c55e; color:white; }
    .secondary{ background:#111827; color:white; }
    .ghost{ background: rgba(17,24,39,.08); color:#111827; border:2px solid rgba(17,24,39,.16); }

    .tiny{
      font-size: 12px;
      color: rgba(17,24,39,.72);
      font-weight: 900;
      margin-top: 10px;
      text-align:center;
    }

    .hidden{ display:none !important; }

    /* Level map grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    @media (min-width: 640px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: repeat(3, 1fr); }
    }

    .levelCard{
      background: rgba(255,255,255,.85);
      border: 2px solid rgba(17,24,39,.10);
      border-radius: 20px;
      padding: 12px;
      box-shadow: 0 14px 35px rgba(0,0,0,.12);
      display:flex;
      flex-direction:column;
      gap: 8px;
      position: relative;
      overflow:hidden;
    }

    .levelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .levelTitle{
      font-weight: 1000;
      font-size: 18px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .levelMeta{
      font-weight: 900;
      font-size: 13px;
      color: rgba(17,24,39,.75);
    }

    .badgeRow{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }

    .chip{
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 1000;
      font-size: 12px;
      background: rgba(17,24,39,.06);
      border: 2px solid rgba(17,24,39,.10);
      color: rgba(17,24,39,.85);
    }

    .chip.ok{ background: rgba(34,197,94,.14); border-color: rgba(34,197,94,.30); }
    .chip.lock{ background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.22); }

    .levelBtn{
      margin-top: 6px;
      width: 100%;
    }

    .lockOverlay{
      position:absolute;
      inset:0;
      background: linear-gradient(135deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight: 1000;
      font-size: 18px;
      gap: 10px;
    }

    /* Trophy list */
    .trophyList{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
      max-height: min(60dvh, 420px);
      overflow:auto;
      padding-right: 4px;
    }
    .trophyItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(255,255,255,.85);
      border: 2px solid rgba(17,24,39,.10);
    }
    .trophyLeft{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .trophyIcon{ font-size: 28px; }
    .trophyName{ font-weight: 1000; }
    .trophyMeta{ font-weight: 900; font-size: 12px; color: rgba(17,24,39,.70); }

    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      .item{ animation: none !important; }
      .floating{ animation: none !important; }
      #glow{ transition: none !important; }
    }
  </style>
</head>

<body>
  <div id="glow"></div>

  <div id="topbar">
    <div id="brand">üó∫Ô∏è Marc ‚Äî Level Quest</div>
    <div class="hud">
      <div class="pill" id="hudText">Alege un nivel üéØ</div>
      <button class="iconbtn" id="btnTrophies" title="Trofee">üèÖ</button>
      <button class="iconbtn" id="btnSound" title="Sunet">üîä OFF</button>
      <button class="iconbtn" id="btnHome" title="Harta">üó∫Ô∏è</button>
    </div>
  </div>

  <div id="game"></div>

  <!-- LEVEL MAP -->
  <div id="mapModal" class="modal">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 style="margin:0">Harta Nivelurilor üß©</h2>
          <p style="margin:6px 0 0">C√¢»ôtigƒÉ o medalie pe fiecare nivel: <b>5/5</b> üèÖ</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <button class="ghost" id="btnReset">Reset progres</button>
          <button class="secondary" id="btnCloseMap">√énchide</button>
        </div>
      </div>

      <div class="grid" id="levelGrid"></div>
      <div class="tiny">Tip: Nivelul 2 (1‚Äì10) e ‚Äû√Æn ordine‚Äù ‚Äî perfect pentru 4‚Äì5 ani üî¢</div>
    </div>
  </div>

  <!-- END / WIN -->
  <div id="endModal" class="modal hidden">
    <div class="card" style="text-align:center;">
      <h2 id="endTitle" style="margin:6px 0 8px;">BRAVO! üèÖ</h2>
      <p id="endMsg" style="margin:0 0 6px;">Ai terminat nivelul!</p>
      <p id="endStats" style="margin:0 0 10px; color: rgba(17,24,39,.8);"></p>
      <div class="actions">
        <button class="primary" id="btnNext">UrmƒÉtorul nivel ‚û°Ô∏è</button>
        <button class="ghost" id="btnReplay">RepetƒÉ nivelul üîÅ</button>
        <button class="secondary" id="btnBackToMap">Harta üó∫Ô∏è</button>
      </div>
      <div class="tiny">Putem face »ôi Level 6+ (silabe, cuvinte scurte, opera»õii +/‚àí) üòÑ</div>
    </div>
  </div>

  <!-- TROPHIES -->
  <div id="trophyModal" class="modal hidden">
    <div class="card">
      <div class="cardHeader">
        <div>
          <h2 style="margin:0">Album Trofee üèÖ</h2>
          <p style="margin:6px 0 0">Se salveazƒÉ automat pe device (LocalStorage).</p>
        </div>
        <div style="display:flex; gap:10px;">
          <button class="ghost" id="btnExportHint" title="LocalStorage e deja exportabil din devtools üôÇ">Info</button>
          <button class="secondary" id="btnCloseTrophies">√énchide</button>
        </div>
      </div>

      <div class="trophyList" id="trophyList"></div>

      <div class="actions">
        <button class="ghost" id="btnReset2">Reset progres</button>
        <button class="secondary" id="btnCloseTrophies2">√énchide</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = 'marc_level_quest_v1';

  const game = document.getElementById('game');
  const glow = document.getElementById('glow');

  const hudText = document.getElementById('hudText');
  const btnTrophies = document.getElementById('btnTrophies');
  const btnSound = document.getElementById('btnSound');
  const btnHome = document.getElementById('btnHome');

  const mapModal = document.getElementById('mapModal');
  const levelGrid = document.getElementById('levelGrid');
  const btnReset = document.getElementById('btnReset');
  const btnCloseMap = document.getElementById('btnCloseMap');

  const endModal = document.getElementById('endModal');
  const endTitle = document.getElementById('endTitle');
  const endMsg = document.getElementById('endMsg');
  const endStats = document.getElementById('endStats');
  const btnNext = document.getElementById('btnNext');
  const btnReplay = document.getElementById('btnReplay');
  const btnBackToMap = document.getElementById('btnBackToMap');

  const trophyModal = document.getElementById('trophyModal');
  const trophyList = document.getElementById('trophyList');
  const btnCloseTrophies = document.getElementById('btnCloseTrophies');
  const btnCloseTrophies2 = document.getElementById('btnCloseTrophies2');
  const btnReset2 = document.getElementById('btnReset2');
  const btnExportHint = document.getElementById('btnExportHint');

  // ======= tiny optional sound (WebAudio) =======
  let soundOn = false;
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) audioCtx = new AC();
    }
  }
  function beep(freq=660, ms=70){
    if (!soundOn) return;
    ensureAudio();
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.frequency.value = freq;
    o.type = 'sine';
    g.gain.value = 0.04;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, ms);
  }

  // ======= helper =======
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));
  const nowISO = () => new Date().toISOString();
  const fmtDate = (iso) => {
    if (!iso) return '‚Äî';
    const d = new Date(iso);
    return d.toLocaleString('ro-RO', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
  };

  function glowPulse(){
    glow.style.opacity = '1';
    setTimeout(()=> glow.style.opacity = '0', 180);
  }

  function confettiBurst(){
    confetti({ particleCount: 80, spread: 80, startVelocity: 35, origin: { y: 0.65 } });
  }

  function confettiParty(ms=1600){
    const t0 = Date.now();
    const iv = setInterval(() => {
      confetti({
        particleCount: 45,
        spread: 90,
        startVelocity: 28,
        origin: { x: Math.random(), y: Math.random()*0.4 + 0.2 }
      });
      if (Date.now() - t0 > ms) clearInterval(iv);
    }, 220);
  }

  function showFloating(x, y, text, color){
    const el = document.createElement('div');
    el.className = 'floating';
    el.textContent = text;
    el.style.color = color;
    const pad = 10;
    const vw = window.innerWidth, vh = window.innerHeight;
    const left = clamp(x - 40, pad, vw - 140);
    const top  = clamp(y - 60, pad + 60, vh - 140);
    el.style.left = left + 'px';
    el.style.top = top + 'px';
    game.appendChild(el);
    setTimeout(()=> el.remove(), 900);
  }

  // ======= Levels definition =======
  const LEVELS = [
    {
      id: 'letters',
      title: 'MARC',
      icon: 'üß©',
      medal: 'ü•â',
      desc: 'Prinde literele M A R C (orice ordine).',
      mode: 'set',
      targets: ['M','A','R','C'],
      targetRenderer: (val) => {
        const span = document.createElement('div');
        span.className = 'token';
        span.textContent = val;
        return span;
      },
      spawn: { target: 0.62, bad: 0.14, fun: 0.24 }
    },
    {
      id: 'numbers',
      title: '1‚Äì10',
      icon: 'üî¢',
      medal: 'ü•à',
      desc: 'Prinde numerele 1‚Üí10 √Æn ordine.',
      mode: 'sequence',
      targets: ['1','2','3','4','5','6','7','8','9','10'],
      targetRenderer: (val) => {
        const span = document.createElement('div');
        span.className = 'token';
        span.textContent = val;
        return span;
      },
      spawn: { target: 0.68, bad: 0.12, fun: 0.20 }
    },
    {
      id: 'colors',
      title: 'Culori',
      icon: 'üé®',
      medal: 'ü•á',
      desc: 'Prinde toate culorile: ro»ôu, galben, verde, albastru, mov.',
      mode: 'set',
      targets: ['red','yellow','green','blue','purple'],
      labels: { red:'Ro»ôu', yellow:'Galben', green:'Verde', blue:'Albastru', purple:'Mov' },
      targetRenderer: (val, level) => {
        const dot = document.createElement('div');
        dot.className = 'colorDot';
        dot.style.setProperty('--c', colorHex(val));
        dot.title = level.labels[val] || val;
        return dot;
      },
      spawn: { target: 0.64, bad: 0.12, fun: 0.24 }
    },
    {
      id: 'shapes',
      title: 'Forme',
      icon: 'üî∫',
      medal: 'üèÖ',
      desc: 'Prinde toate formele: cerc, pƒÉtrat, triunghi, diamant, stea.',
      mode: 'set',
      targets: ['circle','square','triangle','diamond','star'],
      labels: { circle:'Cerc', square:'PƒÉtrat', triangle:'Triunghi', diamond:'Diamant', star:'Stea' },
      targetRenderer: (val) => {
        const box = document.createElement('div');
        box.className = 'shapeToken';
        box.textContent = shapeChar(val);
        box.style.background = 'rgba(255,255,255,.35)';
        return box;
      },
      spawn: { target: 0.62, bad: 0.14, fun: 0.24 }
    },
    {
      id: 'animals',
      title: 'Animale',
      icon: 'ü¶ä',
      medal: 'üèÜ',
      desc: 'Prinde animalele: c√¢ine, pisicƒÉ, iepure, urs, vulpe.',
      mode: 'set',
      targets: ['dog','cat','rabbit','bear','fox'],
      labels: { dog:'C√¢ine', cat:'PisicƒÉ', rabbit:'Iepure', bear:'Urs', fox:'Vulpe' },
      targetRenderer: (val) => {
        const em = document.createElement('div');
        em.className = 'emoji';
        em.textContent = animalEmoji(val);
        return em;
      },
      spawn: { target: 0.60, bad: 0.14, fun: 0.26 }
    }
  ];

  const FUN_EMOJIS = ['ü¶ñ','üöÄ','‚≠ê','üåà','üçÑ','üçì','üßÉ','‚ö°','üß†'];
  const BAD_EMOJIS = ['üåßÔ∏è','‚òÅÔ∏è','‚õàÔ∏è'];

  const PRAISE = ["Super! ‚ú®", "Bravo! üèÖ", "High-five! üñêÔ∏è", "E»ôti tare! üí™", "Perfect! üòÑ", "Bun! üî•"];

  function shapeChar(v){
    switch(v){
      case 'circle': return '‚óè';
      case 'square': return '‚ñ†';
      case 'triangle': return '‚ñ≤';
      case 'diamond': return '‚óÜ';
      case 'star': return '‚òÖ';
      default: return '‚ú¶';
    }
  }
  function animalEmoji(v){
    switch(v){
      case 'dog': return 'üê∂';
      case 'cat': return 'üê±';
      case 'rabbit': return 'üê∞';
      case 'bear': return 'üêª';
      case 'fox': return 'ü¶ä';
      default: return 'üêæ';
    }
  }
  function colorHex(v){
    switch(v){
      case 'red': return '#ef4444';
      case 'yellow': return '#f59e0b';
      case 'green': return '#22c55e';
      case 'blue': return '#3b82f6';
      case 'purple': return '#a855f7';
      default: return '#60a5fa';
    }
  }

  // ======= Persistent state =======
  const defaultState = () => ({
    settings: { soundOn: false },
    progress: {
      levels: Object.fromEntries(LEVELS.map(l => [l.id, {
        completed: false,
        bestTime: null,
        lastTime: null,
        tries: 0,
        lastPlayed: null
      }]))
    }
  });

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      // minimal migration safety
      const base = defaultState();
      const merged = {
        settings: { ...base.settings, ...(parsed.settings || {}) },
        progress: { levels: { ...base.progress.levels, ...((parsed.progress && parsed.progress.levels) || {}) } }
      };
      return merged;
    }catch(e){
      return defaultState();
    }
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch(e){}
  }

  function resetProgress(){
    state = defaultState();
    soundOn = !!state.settings.soundOn;
    syncSoundButton();
    saveState();
    renderMap();
    renderTrophies();
  }

  // ======= Unlock logic =======
  function isUnlocked(levelId){
    const idx = LEVELS.findIndex(l => l.id === levelId);
    if (idx === 0) return true;
    const prev = LEVELS[idx - 1].id;
    return !!state.progress.levels[prev]?.completed;
  }

  // ======= UI: Map =======
  function renderMap(){
    levelGrid.innerHTML = '';

    LEVELS.forEach((lvl, idx) => {
      const prog = state.progress.levels[lvl.id];
      const unlocked = isUnlocked(lvl.id);

      const card = document.createElement('div');
      card.className = 'levelCard';

      const top = document.createElement('div');
      top.className = 'levelTop';

      const title = document.createElement('div');
      title.className = 'levelTitle';
      title.innerHTML = `<span style="font-size:22px">${lvl.icon}</span> <span>${idx+1}. ${lvl.title}</span>`;

      const meta = document.createElement('div');
      meta.className = 'levelMeta';
      const best = prog.bestTime ? `${prog.bestTime}s` : '‚Äî';
      meta.textContent = `Best: ${best}`;

      top.appendChild(title);
      top.appendChild(meta);

      const desc = document.createElement('div');
      desc.style.fontWeight = '900';
      desc.style.color = 'rgba(17,24,39,.78)';
      desc.style.fontSize = '13px';
      desc.textContent = lvl.desc;

      const badges = document.createElement('div');
      badges.className = 'badgeRow';

      const chipStatus = document.createElement('div');
      chipStatus.className = 'chip ' + (prog.completed ? 'ok' : (unlocked ? '' : 'lock'));
      chipStatus.textContent = prog.completed ? `Medalie: ${lvl.medal}` : (unlocked ? 'Disponibil' : 'Blocat');
      badges.appendChild(chipStatus);

      const chipTries = document.createElement('div');
      chipTries.className = 'chip';
      chipTries.textContent = `√éncercƒÉri: ${prog.tries || 0}`;
      badges.appendChild(chipTries);

      const chipLast = document.createElement('div');
      chipLast.className = 'chip';
      chipLast.textContent = `Ultima: ${fmtDate(prog.lastPlayed)}`;
      badges.appendChild(chipLast);

      const btn = document.createElement('button');
      btn.className = 'primary levelBtn';
      btn.textContent = unlocked ? (prog.completed ? 'JoacƒÉ din nou' : 'Start nivel') : 'Blocat';
      btn.disabled = !unlocked;
      btn.addEventListener('click', () => startLevel(lvl.id));

      card.appendChild(top);
      card.appendChild(desc);
      card.appendChild(badges);
      card.appendChild(btn);

      if(!unlocked){
        const lock = document.createElement('div');
        lock.className = 'lockOverlay';
        lock.innerHTML = `üîí Blocat`;
        card.appendChild(lock);
      }

      levelGrid.appendChild(card);
    });

    openMap(true);
    setHudText('Alege un nivel üéØ');
  }

  function openMap(open){
    mapModal.classList.toggle('hidden', !open);
  }

  // ======= UI: Trophies =======
  function renderTrophies(){
    trophyList.innerHTML = '';

    LEVELS.forEach((lvl, idx) => {
      const prog = state.progress.levels[lvl.id];
      const row = document.createElement('div');
      row.className = 'trophyItem';

      const left = document.createElement('div');
      left.className = 'trophyLeft';

      const icon = document.createElement('div');
      icon.className = 'trophyIcon';
      icon.textContent = prog.completed ? lvl.medal : '‚¨ú';

      const text = document.createElement('div');
      const name = document.createElement('div');
      name.className = 'trophyName';
      name.textContent = `${idx+1}. ${lvl.icon} ${lvl.title}`;

      const meta = document.createElement('div');
      meta.className = 'trophyMeta';
      meta.textContent = `Best: ${prog.bestTime ? prog.bestTime+'s' : '‚Äî'} ‚Ä¢ √éncercƒÉri: ${prog.tries || 0} ‚Ä¢ Ultima: ${fmtDate(prog.lastPlayed)}`;

      text.appendChild(name);
      text.appendChild(meta);

      left.appendChild(icon);
      left.appendChild(text);

      const right = document.createElement('div');
      right.style.fontWeight = '1000';
      right.style.fontSize = '13px';
      right.style.color = prog.completed ? 'rgba(34,197,94,.9)' : 'rgba(17,24,39,.55)';
      right.textContent = prog.completed ? 'C√¢»ôtigat ‚úÖ' : '√éncƒÉ nu';

      row.appendChild(left);
      row.appendChild(right);

      trophyList.appendChild(row);
    });
  }

  function openTrophies(open){
    trophyModal.classList.toggle('hidden', !open);
    if(open) renderTrophies();
  }

  // ======= Gameplay =======
  let active = false;
  let spawnTimer = null;
  let startTime = 0;
  let currentLevel = null;

  // tuning for kids
  const SPAWN_MS = 950;
  const FALL_MIN = 4.0;
  const FALL_MAX = 6.2;
  const MAX_ONSCREEN = 12;

  let collectedSet = new Set();
  let seqIndex = 0;

  function cleanupField(){
    game.querySelectorAll('.item, .floating').forEach(el => el.remove());
  }

  function setHudText(text){
    hudText.textContent = text;
  }

  function updateHud(){
    if(!currentLevel){
      setHudText('Alege un nivel üéØ');
      return;
    }

    const lvl = currentLevel;
    if(lvl.mode === 'sequence'){
      const next = lvl.targets[seqIndex] || '‚Äî';
      setHudText(`${lvl.icon} ${lvl.title} ‚Ä¢ UrmƒÉtorul: ${next} ‚Ä¢ ${seqIndex}/${lvl.targets.length}`);
    } else {
      const done = collectedSet.size;
      setHudText(`${lvl.icon} ${lvl.title} ‚Ä¢ ${done}/${lvl.targets.length}`);
    }
  }

  function startLevel(levelId){
    const lvl = LEVELS.find(l => l.id === levelId);
    if(!lvl) return;
    if(!isUnlocked(levelId)) return;

    // increment tries
    state.progress.levels[levelId].tries = (state.progress.levels[levelId].tries || 0) + 1;
    state.progress.levels[levelId].lastPlayed = nowISO();
    saveState();

    currentLevel = lvl;
    collectedSet = new Set();
    seqIndex = 0;

    cleanupField();
    openMap(false);
    openTrophies(false);
    endModal.classList.add('hidden');

    active = true;
    startTime = Date.now();
    updateHud();

    if (spawnTimer) clearInterval(spawnTimer);
    spawnTimer = setInterval(spawnItem, SPAWN_MS);
  }

  function endLevel(completed){
    active = false;
    if (spawnTimer) clearInterval(spawnTimer);
    cleanupField();

    if(!currentLevel) return;

    const elapsed = Math.max(1, Math.round((Date.now() - startTime) / 1000));
    const prog = state.progress.levels[currentLevel.id];

    prog.lastTime = elapsed;
    if(completed){
      prog.completed = true;
      prog.bestTime = prog.bestTime ? Math.min(prog.bestTime, elapsed) : elapsed;
    }
    saveState();

    // show end modal (only if completed)
    if(completed){
      glowPulse();
      confettiBurst();
      confettiParty(1600);
      beep(880, 70);

      endTitle.textContent = `BRAVO! ${currentLevel.medal}`;
      endMsg.textContent = `Ai c√¢»ôtigat medalia la ${currentLevel.icon} ${currentLevel.title}!`;
      const best = prog.bestTime ? prog.bestTime + 's' : '‚Äî';
      endStats.textContent = `Timp: ${elapsed}s ‚Ä¢ Best: ${best} ‚Ä¢ √éncercƒÉri: ${prog.tries || 0}`;

      // next button enable/disable
      const idx = LEVELS.findIndex(l => l.id === currentLevel.id);
      const hasNext = idx < LEVELS.length - 1;
      btnNext.disabled = !hasNext;
      btnNext.style.opacity = hasNext ? '1' : '.55';

      endModal.classList.remove('hidden');
    } else {
      // fallback
      renderMap();
    }
  }

  function completeIfReady(){
    if(!currentLevel) return;
    if(currentLevel.mode === 'sequence'){
      if(seqIndex >= currentLevel.targets.length) endLevel(true);
    } else {
      if(collectedSet.size >= currentLevel.targets.length) endLevel(true);
    }
  }

  function randomFallDuration(isTarget){
    // targets slightly slower (easier)
    const min = isTarget ? FALL_MIN : (FALL_MIN - 0.2);
    const max = isTarget ? FALL_MAX : (FALL_MAX - 0.1);
    return (Math.random() * (max - min) + min).toFixed(2);
  }

  function spawnItem(){
    if(!active || !currentLevel) return;
    if (game.querySelectorAll('.item').length >= MAX_ONSCREEN) return;

    const lvl = currentLevel;

    // decide type
    const r = Math.random();
    let kind = 'fun'; // fun / bad / target
    if (r < lvl.spawn.target) kind = 'target';
    else if (r < lvl.spawn.target + lvl.spawn.bad) kind = 'bad';
    else kind = 'fun';

    // build element
    const wrap = document.createElement('div');
    wrap.className = 'item';

    // choose payload
    let payload = null;
    let isTarget = (kind === 'target');

    if(kind === 'bad'){
      payload = BAD_EMOJIS[Math.floor(Math.random() * BAD_EMOJIS.length)];
      const el = document.createElement('div');
      el.className = 'emoji';
      el.textContent = payload;
      wrap.dataset.kind = 'bad';
      wrap.appendChild(el);
    } else if(kind === 'fun'){
      payload = FUN_EMOJIS[Math.floor(Math.random() * FUN_EMOJIS.length)];
      const el = document.createElement('div');
      el.className = 'emoji';
      el.textContent = payload;
      wrap.dataset.kind = 'fun';
      wrap.appendChild(el);
    } else {
      // target
      // for sequence mode: prefer the "next" target to spawn a bit more
      if(lvl.mode === 'sequence'){
        const next = lvl.targets[seqIndex] || lvl.targets[lvl.targets.length - 1];
        const roll = Math.random();
        payload = roll < 0.72 ? next : lvl.targets[Math.floor(Math.random() * lvl.targets.length)];
      } else {
        // prefer missing ones
        const missing = lvl.targets.filter(t => !collectedSet.has(t));
        payload = (missing.length && Math.random() < 0.75)
          ? missing[Math.floor(Math.random() * missing.length)]
          : lvl.targets[Math.floor(Math.random() * lvl.targets.length)];
      }

      wrap.dataset.kind = 'target';
      wrap.dataset.val = payload;

      const rendered = lvl.targetRenderer(payload, lvl);
      wrap.appendChild(rendered);
    }

    // position
    const leftPct = Math.random() * 78 + 11; // 11..89
    wrap.style.left = leftPct + '%';

    // duration
    const dur = randomFallDuration(isTarget);
    wrap.style.animationDuration = dur + 's';

    wrap.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      const x = e.clientX;
      const y = e.clientY;
      catchItem(wrap, x, y);
    });

    game.appendChild(wrap);

    setTimeout(() => {
      if (wrap.parentNode) wrap.remove();
    }, Number(dur) * 1000);
  }

  function catchItem(wrap, x, y){
    if(!active || !currentLevel) return;

    // stop animation to avoid jump
    wrap.style.animation = 'none';

    const kind = wrap.dataset.kind;
    if(kind === 'bad'){
      beep(220, 90);
      showFloating(x, y, "Ups! ‚òî", 'var(--bad)');
      if (navigator.vibrate) navigator.vibrate(120);
    } else if(kind === 'fun'){
      beep(720, 55);
      const msg = PRAISE[Math.floor(Math.random() * PRAISE.length)];
      showFloating(x, y, msg, '#0b1220');
    } else {
      // target
      const val = wrap.dataset.val;
      const lvl = currentLevel;

      if(lvl.mode === 'sequence'){
        const next = lvl.targets[seqIndex];
        if(val === next){
          seqIndex++;
          glowPulse(); confettiBurst();
          beep(880, 70);
          showFloating(x, y, `Corect! ‚úÖ`, 'var(--good)');
          updateHud();
          completeIfReady();
        } else {
          // gentle feedback (no hard penalty)
          beep(420, 70);
          showFloating(x, y, `Nu √ÆncƒÉ üòÑ`, 'rgba(17,24,39,.75)');
        }
      } else {
        if(!collectedSet.has(val)){
          collectedSet.add(val);
          glowPulse(); confettiBurst();
          beep(880, 70);

          // label friendly for colors/shapes/animals
          let nice = val;
          if(lvl.labels && lvl.labels[val]) nice = lvl.labels[val];
          showFloating(x, y, `+ ${nice} ‚úÖ`, 'var(--good)');

          updateHud();
          completeIfReady();
        } else {
          beep(600, 55);
          showFloating(x, y, "Avem deja üòÑ", 'rgba(17,24,39,.75)');
        }
      }

      if (navigator.vibrate) navigator.vibrate([60, 30, 60]);
    }

    // pop away
    wrap.style.transition = 'transform 120ms ease, opacity 120ms ease';
    wrap.style.transform = 'scale(1.35)';
    wrap.style.opacity = '0';
    setTimeout(() => { if(wrap.parentNode) wrap.remove(); }, 130);
  }

  // Pause on tab hidden (battery + no surprise)
  document.addEventListener('visibilitychange', () => {
    if (!active) return;
    if (document.hidden) {
      if (spawnTimer) clearInterval(spawnTimer);
    } else {
      if (spawnTimer) clearInterval(spawnTimer);
      spawnTimer = setInterval(spawnItem, SPAWN_MS);
    }
  });

  // ======= Buttons / Navigation =======
  function syncSoundButton(){
    btnSound.textContent = soundOn ? 'üîä ON' : 'üîä OFF';
  }

  btnSound.addEventListener('click', () => {
    soundOn = !soundOn;
    state.settings.soundOn = soundOn;
    syncSoundButton();
    if (soundOn) ensureAudio(); // must be on user gesture
    saveState();
  });

  btnHome.addEventListener('click', () => {
    // stop gameplay and go to map
    active = false;
    if (spawnTimer) clearInterval(spawnTimer);
    cleanupField();
    currentLevel = null;
    updateHud();
    renderMap();
  });

  btnTrophies.addEventListener('click', () => openTrophies(true));

  btnCloseMap.addEventListener('click', () => openMap(false));

  btnReset.addEventListener('click', () => {
    if(confirm('Sigur resetezi tot progresul »ôi trofeele?')) resetProgress();
  });
  btnReset2.addEventListener('click', () => {
    if(confirm('Sigur resetezi tot progresul »ôi trofeele?')) {
      resetProgress();
      openTrophies(true);
    }
  });

  btnCloseTrophies.addEventListener('click', () => openTrophies(false));
  btnCloseTrophies2.addEventListener('click', () => openTrophies(false));

  btnExportHint.addEventListener('click', () => {
    alert('Trofeele sunt √Æn LocalStorage.\nCheie: ' + STORAGE_KEY + '\nPo»õi exporta din DevTools ‚Üí Application/Storage.');
  });

  btnBackToMap.addEventListener('click', () => {
    endModal.classList.add('hidden');
    currentLevel = null;
    renderMap();
  });

  btnReplay.addEventListener('click', () => {
    endModal.classList.add('hidden');
    if(currentLevel) startLevel(currentLevel.id);
  });

  btnNext.addEventListener('click', () => {
    if(!currentLevel) return;
    const idx = LEVELS.findIndex(l => l.id === currentLevel.id);
    const next = LEVELS[idx + 1];
    endModal.classList.add('hidden');
    if(next) startLevel(next.id);
  });

  // ======= Init =======
  function init(){
    soundOn = !!state.settings.soundOn;
    syncSoundButton();
    renderMap();
    renderTrophies();
  }

  init();
})();
</script>

</body>
</html>